<template>
  <div ff-many-quick-search>
    <div class="select-item-box">
      <span class="select-title">目前選擇：</span>
      <draggable :handle="'.select-item'">
        <template v-for="(item, index) in selectItems" :key="index">
          <span class="select-item">
            <router-link
              v-if="item.link"
              :to="item.link"
              :target="item.targetBlank ? '_blank' : null"
            >
              <font-awesome-icon icon="link" /> {{ item.text }}
            </router-link>
            <span v-else>
              {{ item.text }}
            </span>
            <span
              v-if="!readOnly"
              class="select-item-delete"
              @click="deleteSelectItem(item.value)"
            >
              <font-awesome-icon icon="window-close" />
            </span>
            <input type="hidden" :name="inputName" :value="item.value" />
          </span>
        </template>
      </draggable>
      <div v-if="selectItems.length == 0" class="select-item-box-empty">
        尚未選擇
      </div>
    </div>
    <input
      v-if="!readOnly"
      v-model="inputValue"
      ff-many-quick-search-input
      type="text"
      :name="searchInputName"
      :placeholder="inputPlaceholder"
      :style="{ width: inputWidth }"
      :maxlength="inputMaxlength"
      autocomplete="off"
      @focus="getResult($event)"
      @keyup="getResult($event)"
    />
    <button
      v-if="!searchOnlyMatch && !readOnly"
      class="btn btn-success"
      @click="addSelectItem"
    >
      <font-awesome-icon icon="plus" />
      新增
    </button>
    <div class="search-list" :style="listStyle">
      <div class="search-title">{{ title }}</div>
      <template v-for="(result, index) in resultJson" :key="index">
        <div

          class="search-line"
          @click="
            addSelectItem(
              result.text,
              result.value,
              result.link,
              result.targetBlank,
            )
          "
        >
          <span class="search-add">+</span>
          {{ result.text }}
        </div>
      </template>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onBeforeUnmount, computed, watch } from 'vue';
import { VueDraggableNext as Draggable } from 'vue-draggable-next';
import ff from '@fanswoo/core/utils/helper';

interface IListStyle {
  display: 'none' | 'block';
  width: string;
}

interface selectItem {
  text: string;
  value: string;
  link: string;
  targetBlank: boolean;
}

const selectItems = defineModel();
const resultJson = ref<selectItem[]>([]);
const searching = ref(false);
const title = ref('');
const listStyleDisplayNone = ref(false);
const delay = ref(300);
const inputValue = ref('');

const props = defineProps({
  inputWidth: {
    type: Number,
  },
  inputMaxlength: {
    type: Number,
  },
  inputPlaceholder: {
    type: String,
  },
  inputName: {
    type: String,
  },
  searchInputName: {
    type: String,
  },
  searchOnlyMatch: {
    type: Boolean,
  },
  readOnly: {
    type: Boolean,
  },
  listStyleObj: {
    type: Object,
    default: () => ({}),
  },
  url: {
    type: String,
  },
  maxCount: {
    type: Number,
  },
});

const listStyle = computed(() => {
  const styleJson = { ...props.listStyleObj };

  if (listStyleDisplayNone.value) {
    styleJson.display = 'none';
  } else if (resultJson.value.length > 0 || searching.value) {
    styleJson.display = 'block';
  }

  return styleJson;
});

onMounted(() => {
  document.addEventListener('click', onClickDocument, false);
});

const getResult = async (event: Event) => {
  resultJson.value = [];
  title.value = '正在尋找結果 ...';
  if (listStyle.value.width && Number.parseFloat(listStyle.value.width) === 0) {
    listStyle.value.width = ($(event.target).width()! + 2).toString();
  }
  listStyleDisplayNone.value = false;
  searching.value = true;

  await ff.sleep(delay.value);

  const data = (<any>$(event.target).parents('form')).serializeJSON({
    parseBooleans: true,
  });

  data.inputName = props.inputName;
  data.searchInputName = inputValue.value;
  searching.value = true;

  let response;
  try {
    response = await axios.post(props.url, data);
  } catch (error) {
    console.warn(error);
  }

  resultJson.value = response.data;

  if (resultJson.value.length === 0) {
    title.value = '沒有相似的搜尋';
    return;
  }

  title.value = '搜尋結果 ...';
};

const addSelectItem = (text: string, value: string, link: string, targetBlank: boolean) => {
  let newText = text;
  let newVal = value;
  let newResult;

  if (!text && inputValue.value) {
    newText = inputValue.value;
    newVal = inputValue.value;
  }

  if (!newText || !newVal || props.readOnly) {
    return;
  }

  for (let i = 0; i < selectItems.value.length; i += 1) {
    if (newVal === selectItems.value[i].value) {
      return;
    }
  }

  if (props.searchOnlyMatch) {
    let searchOnlyMatchBln = 0;

    for (let i = 0; i < resultJson.value.length; i += 1) {
      if (text === resultJson.value[i].text) {
        searchOnlyMatchBln += 1;
        newResult = resultJson.value[i];
        break;
      }
    }

    if (searchOnlyMatchBln === 0) {
      return;
    }
  }

  inputValue.value = '';

  if (props.maxCount > 0 && selectItems.value.length >= props.maxCount) {
    return;
  }

  newResult.text = newText;
  newResult.link = link;
  newResult.targetBlank = targetBlank;

  selectItems.value.push(newResult);
};

const deleteSelectItem = (value: string) => {
  if (props.readOnly) {
    return;
  }

  for (let i = 0; i < selectItems.value.length; i += 1) {
    if (value === selectItems.value[i].value) {
      selectItems.value.splice(i, 1);
      return;
    }
  }
};

const onClickDocument = (event: Event) => {
  if (
    typeof $(event.target).attr('ff-many-quick-search-input') !==
    typeof undefined &&
    $(event.target).attr('ff-many-quick-search-input') !== undefined &&
    searching.value === true
  ) {
    event.stopPropagation();
  } else {
    listStyleDisplayNone.value = true;
  }
};

onBeforeUnmount(() => {
  document.removeEventListener('click', onClickDocument);
});

</script>