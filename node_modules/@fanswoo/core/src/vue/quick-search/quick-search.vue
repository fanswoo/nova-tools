<template>
  <div ff-quick-search>
    <input
      ff-quick-search-input
      type="text"
      :name="inputName"
      :placeholder="inputPlaceholder"
      :value="inputValueData"
      :style="{ width: inputWidthData }"
      :maxlength="inputMaxlength"
      autocomplete="off"
      @change="onChange"
      @input="onInputKey($event)"
      @focus="getResult($event)"
    />
    <div class="search-list" :style="listStyle">
      <div class="search-title">{{ title }}</div>
      <template v-for="(result, index) in resultJson" :key="index">
        <div class="search-line" @click="changeInputValue(result)">
          {{ result.text }}
        </div>
      </template>
    </div>
  </div>
</template>

<script setup lang="ts">

import { computed, onBeforeUnmount, onMounted, ref } from "vue";

const props = defineProps({
  inputWidth: {
    type: Number,
    default: 0,
  },
  inputMaxlength: {
    type: Number,
    default: 100,
  },
  inputValue: {
    type: [String, Number],
    default: '',
  },
  inputPlaceholder: {
    type: [String, Number],
    default: '',
  },
  inputName: {
    type: String,
    default: '',
  },
  listStyleWidth: {
    type: Number,
    default: 0,
  },
  url: {
    type: String,
    default: '',
  },
});

const emit = defineEmits(['onChange']);
const resultJson = ref([]);
const searching = ref(false);
const title = ref('');
const listStyleDisplayNone = ref(false);
const inputValueData = ref(props.inputValue);
const delay = 1000;
const listStyleWidthData = ref(props.listStyleWidth);

const inputWidthData = computed(() => {
  return `${props.inputWidth} px`;
});

const listStyle = computed(() => {
  const styleJson = {};

  if (listStyleDisplayNone.value) {
    styleJson.display = 'none';
  } else if (resultJson.value.length > 0 || searching.value) {
    styleJson.display = 'block';
  }

  styleJson.width = `${listStyleWidthData.value} px`;

  return styleJson;
});

const getResultAxiosDebounce = _.debounce((event) => {
  getResultAxios(event);
}, delay);

onMounted(() => {
  document.addEventListener('click', onClickDocument, false);
});

const onClickDocument = (event) => {
  if (
    typeof $(event.target).attr('ff-quick-search-input') !== typeof undefined &&
    $(event.target).attr('ff-quick-search-input') !== false &&
    searching.value === true
  ) {
    event.stopPropagation();
  } else {
    listStyleDisplayNone.value = true;
  }
};

const resetValue = (value) => {
  inputValueData.value = value;
};

const onInputKey = (event) => {
  inputValueData.value = event.target.value;
  getResult(event);
};

const onChange = (event) => {
  inputValueData.value = event.target.value;

  for (let index = 0; index < resultJson.value.length; index += 1) {
    const result = resultJson.value[index];
    if (result.value === event.target.value) {
      emit('onChange', result);
      return;
    }
  }

  emit('onChange', {
    value: event.target.value,
  });
};

const getResult = (event) => {
  title.value = '正在尋找相近的搜尋 ...';
  if (!listStyleWidthData.value) {
    listStyleWidthData.value = $(event.target).width() + 2;
  }
  listStyleDisplayNone.value = false;
  searching.value = true;

  getResultAxiosDebounce(event);
};

const getResultAxios = async (event) => {
  const data = $(event.target).parents('form').serializeJSON({
    parseBooleans: true,
  });

  data.inputName = inputValueData.value;

  let response;
  try {
    response = await axios.post(props.url, data);
  } catch (error) {
    console.log(error);
  }

  searching.value = true;

  if (response === undefined) {
    getResultAxiosDebounce(event);
  }

  resultJson.value = response.data;

  if (resultJson.value.length === 0) {
    title.value = '沒有相似的搜尋';
    return;
  }

  if (inputValueData.value) {
    title.value = '相近的搜尋結果 ...';
  } else {
    title.value = '建議的搜尋結果 ...';
  }
};

const changeInputValue = (result) => {
  inputValueData.value = result.value;

  emit('onChange', result);
};

onBeforeUnmount(() => {
  document.removeEventListener('click', onClickDocument);
});

defineExpose({
  resetValue
});
</script>
