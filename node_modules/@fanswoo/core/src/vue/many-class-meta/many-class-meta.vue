<template>
  <ClassTags
    v-for="(classTag, index) in classTags"
    @changeManyClassTags="changeManyClassTags"
    :inputName="inputName"
    :classTagTree="classTagTree"
    v-model="classTag.selectedIds"
    :index="index"
  ></ClassTags>
</template>

<script setup lang="ts">
import { onMounted, provide } from 'vue';
import ClassTags from '@fanswoo/core/vue/many-class-meta/class-metas.vue';

const props = defineProps([
  'classTagTree',
  'inputName',
  'multiple',
  'classNames'
]);

const emit = defineEmits(['onChange']);

provide('classNames', props.classNames);
const classTags = defineModel();

const changeManyClassTags = (payload) => {
  if (classTags.value[0] && !props.multiple) {
    emit('onChange', {
      inputName: props.inputName,
      value:
        classTags.value[0].selectedIds[
        classTags.value[0].selectedIds.length - 1
          ],
    });

    return false;
  }

  if (payload.selectedIds[0]) {
    classTags.value[payload.key] = {
      selectedIds: payload.selectedIds,
    };
  } else {
    deleteManyClassTags(payload.key);
  }

  var manyClassTagsLength = 0;
  classTags.value.forEach(function (manyClassTag, index) {
    if (manyClassTag.selectedIds[0] == '') {
      manyClassTagsLength++;
    }
  });

  if (manyClassTagsLength < 1) {
    addManyClassTags();
  }

  if (classTags.value[0]) {
    emit('onChange', {
      inputName: props.inputName,
      value:
        classTags.value[0].selectedIds[
        classTags.value[0].selectedIds.length - 1
          ],
    });
  }
};

const addManyClassTags = () => {
  classTags.value.push({
    selectedIds: [''],
  });
};

const deleteManyClassTags = (key) => {
  classTags.value.splice(key, 1);
};

const resetManyClassTags = () => {
  if (!props.multiple) {
    if (classTags.value && classTags.value.length == 0) {
      classTags.value.push({
        selectedIds: [''],
      });
    }
    return false;
  }

  var number = 0;
  for (var i = 0; i < classTags.value.length; i++) {
    if (classTags.value[i].selectedIds[0]) {
      number++;
    }
  }

  if (
    classTags.value.length == 0 ||
    classTags.value.length == number
  ) {
    classTags.value.push({
      selectedIds: [''],
    });
  }
};

onMounted(() => {
  resetManyClassTags();
});
</script>
