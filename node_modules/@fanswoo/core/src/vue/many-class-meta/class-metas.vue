<template>
  <div>
    <ClassTag
      v-for="(classTagTreeChild, index) in classTagTreeChilds"
      @changeSelected="changeSelected"
      :key="index"
      :layer="index"
      :classTagTreeChild="classTagTreeChild"
      v-model="selectedIds[index]"
      :inputName="
        classTagTreeChilds.length - 1 == index ? inputName : ''
      "
    ></ClassTag>
  </div>
</template>

<script setup lang="ts">
import { onMounted, ref } from 'vue';
import ClassTag from '@fanswoo/core/vue/many-class-meta/class-meta.vue';

const props = defineProps({
  classTagTree: Array,
  inputName: String,
  index: Number,
});

const selectedIds = defineModel();
const emit = defineEmits(['changeManyClassTags']);
const classTagTreeChilds = ref({});

const changeSelected = (payload) => {
  selectedIds.value[payload.layer] = payload.selectedId;

  for (let i = payload.layer + 1; i < selectedIds.value.length; i++) {
    selectedIds.value[i] = '';
  }

  initClassTagTemp();
  emit('changeManyClassTags', {
    key: props.index,
    selectedIds: selectedIds.value,
  });
};

const resetClassTagTempCilids = () => {
  classTagTreeChilds.value = [];
  let key = 0;
  classTagTreeChilds.value[key] = props.classTagTree;

  while (classTagTreeChilds.value[key]) {
    if (!selectedIds.value[key] && key !== 0) {
      let first = Object.keys(classTagTreeChilds.value[key])[0];
      selectedIds.value[key] = first;
    } else if (!selectedIds.value[key]) {
      selectedIds.value[key] = '';
    }

    let selected = selectedIds.value[key];
    let first = Object.keys(classTagTreeChilds.value[key])[0];

    if (
      classTagTreeChilds.value[key][selected] &&
      classTagTreeChilds.value[key][selected].childs
    ) {
      classTagTreeChilds.value[key + 1] =
        classTagTreeChilds.value[key][selected].childs;
    } else if (
      key !== 0 &&
      classTagTreeChilds.value[key][first] &&
      classTagTreeChilds.value[key][first].childs
    ) {
      classTagTreeChilds.value[key + 1] =
        classTagTreeChilds.value[key][first].childs;
    }

    key++;
  }
};

const initClassTagTemp = () => {
  resetClassTagTempCilids();
};

onMounted(() => {
  initClassTagTemp();
});
</script>
