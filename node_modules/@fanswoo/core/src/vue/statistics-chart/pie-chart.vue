<template>
  <div class="line-chart">
    <p>
      選擇日期
      <input
        type="text"
        name="startDate"
        class="start-datepicker"
        v-model="ComponentStartDate"
      />
      -
      <input
        type="text"
        name="endDate"
        class="end-datepicker"
        v-model="ComponentEndDate"
      />
    </p>
    <p>
      選擇次數
      <input
        type="number"
        name="startLimit"
        v-model.number="ComponentStartLimit"
      />
      -
      <input type="number" name="endLimit" v-model.number="ComponentEndLimit" />
      <button @click="reDraw" class="btn btn-primary" :disabled="isDisable">
        送出
      </button>
      <!--<button class="btn btn-primary" :disabled="isDisable">匯出</button>-->
    </p>
  </div>
</template>

<script>
import * as d3 from 'd3';

export default {
  props: ['linkGetJsonPath', 'startDate', 'endDate', 'startLimit', 'endLimit'],
  data: function () {
    return {
      datas: [],
      isDisable: false,
      ComponentStartDate: null,
      ComponentEndDate: null,
      ComponentStartLimit: null,
      ComponentEndLimit: null,
    };
  },
  watch: {
    ComponentStartLimit(value) {
      if (value < 0) {
        this.ComponentStartLimit = 0;
      }

      if (value > this.ComponentEndLimit) {
        this.ComponentStartLimit = this.ComponentEndLimit;
      }
    },
    ComponentEndLimit(value) {
      if (value < 0) {
        this.ComponentEndLimit = 0;
      }
    },
  },
  methods: {
    draw: function () {
      var hasData = this.datas.filter(function (data) {
        return data.value > 0;
      });

      if (hasData.length == 0) {
        d3.select(this.$el).append('div').append('p').text('查無資料');
        return false;
      }

      var svg = d3
        .select(this.$el)
        .append('svg')
        .attr('width', 800)
        .attr('height', 800);

      var margin = {
        top: 20,
        right: 20,
        bottom: 50,
        left: 60,
      };

      //定義寬高
      var width = +svg.attr('width') - margin.left - margin.right;
      var height = +svg.attr('height') - margin.top - margin.bottom;
      var radius = Math.min(width, height) / 2;
      var pie = d3.pie().value(function (d) {
        return d.value;
      });

      var piedata = pie(this.datas);

      piedata = piedata.filter(function (data) {
        return data.value > 0;
      });

      var outerRadius = Math.min(width, height) / 4;
      var innerRadius = 0;

      var arc = d3.arc().innerRadius(innerRadius).outerRadius(outerRadius);

      // var color = d3.scaleOrdinal(d3.schemeCategory10);
      // var color = d3
      //   .scaleLinear()
      //   .domain([1, 10])
      //   .range(["#F00  ", "#0F0"]);
      // var color = d3.scaleOrdinal([
      //   "#66FFFF",
      //   "#33CCFF",
      //   "#0066FF",
      //   "#0000FF",
      //   "#0000AA",
      //   "#FFB7DD",
      //   "#FF0088",
      //   "#FF0000",
      //   "#FF5511",
      //   "#CC0000"
      // ]);

      var color = d3.scaleSequential(d3.interpolateSpectral).domain([1, 10000]);
      var arcs = svg
        .selectAll('g')
        .data(piedata)
        .enter()
        .append('g')
        .attr('transform', 'translate(' + width / 2 + ',' + height / 2 + ')');

      // var g = svg.append("g").attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

      var div = d3.select('body').append('div').attr('class', 'pie-toolTip');

      arcs
        .on('mousemove', function (d) {
          div.style('left', d3.event.pageX + 10 + 'px');
          div.style('top', d3.event.pageY - 25 + 'px');
          div.style('display', 'inline-block');
          div.html(
            d.data.class +
              '<br>' +
              (
                (Number(d.data.value) /
                  d3.sum(piedata, function (d) {
                    return d.data.value;
                  })) *
                100
              ).toFixed(1) +
              '%' +
              '<br>' +
              d.data.value,
          );
        })
        .on('mouseout', function (d) {
          div.style('display', 'none');
          $(this).siblings().css({ opacity: '1' });
        })
        .on('mouseover', function (d) {
          $(this).css({ opacity: '1' }).siblings().css({ opacity: '0.2' });
        })
        .on('click', function (d) {
          // location.href = $('base').attr('href') + 'admin/common/user/user/list/view?'
          //                                         +'startOrderTimes='+ (+d.data.class_value != 0 ? d.data.class_value : "\'0\'")
          //                                         +'&endOrderTimes='+ (+d.data.class_value != 0 ? d.data.class_value : "\'0\'")
          //                                         +'&startDate='+$('input[name="startDate"]').val()
          //                                         +'&endDate='+$('input[name="endDate"]').val();
          let href =
            $('base').attr('href') +
            'admin/common/user/user/list/view?' +
            'startOrderTimes=' +
            (+d.data.class_value != 0 ? d.data.class_value : "'0'") +
            '&endOrderTimes=' +
            (+d.data.class_value != 0 ? d.data.class_value : "'0'") +
            '&startDate=' +
            $('input[name="startDate"]').val() +
            '&endDate=' +
            $('input[name="endDate"]').val();

          window.open(href, '_blank');
        });

      arcs
        .append('path')
        .attr('fill', function (d, i) {
          return color((i + 1) * 500);
        })
        .attr('stroke', '#FFFFFF')
        .attr('d', function (d) {
          return arc(d);
        });

      // var svgLegned4 = d3
      //     .select(".legend4")
      //     .append("svg")
      //     .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
      //     .attr("width", 500)
      //     .attr("height", 100);

      // var dataL = 0;
      // var offset = 80;

      // var legend4 = svgLegned4
      //     .selectAll(".legends4")
      //     .data(piedata)
      //     .enter()
      //     .append("g")
      //     .attr("class", "legends4")
      //     .attr("transform", function(d, i) {
      //     if (i === 0) {
      //         // dataL = d.length + offset;
      //         return "translate(0,0)";
      //     } else {
      //         var newdataL = d.index * 100;
      //         // dataL += d.index + offset;
      //         // console.log(d);
      //         return "translate(" + newdataL + ",0)";
      //     }
      //     });

      // legend4
      //     .append("rect")
      //     .attr("x", 0)
      //     .attr("y", 0)
      //     .attr("width", 17)
      //     .attr("height", 17)
      //     .style("fill", function(d, i) {
      //     return color(i);
      //     });

      // legend4
      //     .append("text")
      //     .attr("x", 20)
      //     .attr("y", 15)
      //     //.attr("dy", ".35em")
      //     .text(function(d, i) {
      //     return d;
      //     })
      //     .attr("class", "textselected")
      //     .style("text-anchor", "start")
      //     .style("font-size", 15);

      var label = d3
        .arc()
        .outerRadius(radius / 1.8)
        .innerRadius(radius / 1.8);

      arcs
        .append('text')
        .attr('transform', function (d, i) {
          var pos = arc.centroid(d);
          pos[0] = (radius / 1.8) * (midAngle(d) < Math.PI ? 1 : -1);

          var percent = ((d.endAngle - d.startAngle) / (2 * Math.PI)) * 100;
          var labely = label.centroid(d)[1];
          if (percent < 3) {
            //console.log(percent)
            // pos[1] += i*15 ;
            labely =
              label.centroid(d)[1] + i * (midAngle(d) < Math.PI ? 15 : -15);
          }

          return 'translate(' + pos[0] + ',' + labely + ')';
        })
        .text(function (d) {
          return d.data.class;
        })
        .attr('fill', function (d, i) {
          return 'black';
        })
        .attr('text-anchor', 'left')
        .attr('dx', function (d) {
          var ac = midAngle(d) < Math.PI ? 0 : -50;
          return ac;
        })
        .attr('dy', 5);

      function midAngle(d) {
        return d.startAngle + (d.endAngle - d.startAngle) / 2;
      }

      // var polyline = arcs.selectAll("polyline")
      // .data(piedata, function(d) {
      //     console.log(d);
      //     return d.data.value;
      // })
      // .enter()
      arcs
        .append('polyline')
        .attr('points', function (d, i) {
          var pos = arc.centroid(d);
          pos[0] = (radius / 1.8) * 0.95 * (midAngle(d) < Math.PI ? 1 : -1);
          var o = arc.centroid(d);
          var percent = ((d.endAngle - d.startAngle) / (2 * Math.PI)) * 100;
          var labely = label.centroid(d)[1];
          if (percent < 3) {
            // console.log(percent);
            o[1];
            // pos[1] += i*15;
            labely =
              label.centroid(d)[1] + i * (midAngle(d) < Math.PI ? 15 : -15);
          }
          //return [label.centroid(d),[o[0],0[1]] , pos];
          // console.log([o[0]*2,pos[1]*2] , [label.centroid(d)[0],label.centroid(d)[1]] , [pos[0],label.centroid(d)[1]]);
          return [
            [o[0] * 2, pos[1] * 2],
            [label.centroid(d)[0], labely],
            [pos[0], labely],
          ];
        })
        .style('fill', 'none')
        //.attr('stroke','grey')
        .attr('stroke', function (d, i) {
          return 'black';
        })
        .style('stroke-width', '1px');

      // arcs
      //   .append("text")
      //   .attr("transform", function(d) {
      //     var x = arc.centroid(d)[0] * 1.4;
      //     var y = arc.centroid(d)[1] * 1.4;
      //     return "translate(" + x + "," + y + ")";
      //   })
      //   .attr("text-anchor", "middle")
      //   .text(function(d) {
      //     var percent =
      //       Number(d.value) /
      //       d3.sum(piedata, function(d) {
      //         return d.value;
      //       }) *
      //       100;
      //     return percent.toFixed(1) + "%";
      //   });

      /**暫時不用這個方法 */
      // arcs
      // .append("line")
      // .attr("stroke", "black")
      // .attr("x1", function(d) {
      //     return arc.centroid(d)[0] * 2;
      // })
      // .attr("y1", function(d) {
      //     return arc.centroid(d)[1] * 2;
      // })
      // .attr("x2", function(d) {
      //     return arc.centroid(d)[0] * 2.2;
      // })
      // .attr("y2", function(d) {
      //     return arc.centroid(d)[1] * 2.2;
      // });

      // arcs
      // .append("text")
      // .attr("transform", function(d) {
      //     var x = arc.centroid(d)[0] * 2.5;
      //     var y = arc.centroid(d)[1] * 2.5;
      //     return "translate(" + x + "," + y + ")";
      // })
      // .attr("text-anchor", "middle")
      // .text(function(d) {
      //     return d.data.class;
      // });
    },
    getData: function (options) {
      return new Promise(function (resolve, reject) {
        $.ajax(options).done(resolve).fail(reject);
      });
    },
    reDraw: function () {
      var _this = this;
      //   _this.changeProps();
      //   console.log(this.startDate);
      _this.isDisable = !_this.isDisable;
      this.clearChart();
      let startDate = $('input[name="startDate"]').val();
      let endDate = $('input[name="endDate"]').val();
      let startLimit = $('input[name="startLimit"]').val();
      let endLimit = $('input[name="endLimit"]').val();
      // this.draw(startDate, endDate);

      this.getData({
        url: $('base').attr('href') + _this.linkGetJsonPath,
        data: {
          startDate: startDate,
          endDate: endDate,
          startLimit: startLimit,
          endLimit: endLimit,
        },
        type: 'GET',
      })
        .then(function (result) {
          result = JSON.parse(result);
          _this.datas = result;
          _this.draw();
          _this.isDisable = !_this.isDisable;
        })
        .catch((e) => {
          console.log(e);
        });
    },
    clearChart: function () {
      d3.select(this.$el).selectAll('svg').remove();

      d3.select(this.$el).selectAll('div').remove();
    },
    // changeProps: function(){
    //     this.clonedsStartDate = $('input[name="startDate"]').val();
    //     this.clonedsEndDate = $('input[name="endDate"]').val();
    //     this.clonedsStartLimit = $('input[name="startLimit"]').val();
    //     this.clonedsEndLimit = $('input[name="endLimit"]').val();
    // }
  },
  //   computed:{
  //       clonedsStartDate :{
  //           get:function(){
  //               return this.startDate;
  //           },
  //           set:function(newValue){
  //             //   console.log(newValue);
  //               this.$emit('change-start-date',newValue);
  //           }
  //       },
  //       clonedsEndDate :{
  //           get:function(){
  //               return this.endDate;
  //           },
  //           set:function(newValue){
  //             //   console.log(newValue);
  //               this.$emit('change-end-date',newValue);
  //           }
  //       },
  //       clonedsStartLimit :{
  //           get:function(){
  //               return this.startLimit;
  //           },
  //           set:function(newValue){
  //             //   console.log(newValue);
  //               this.$emit('change-start-limit',newValue);
  //           }
  //       },
  //       clonedsEndLimit :{
  //           get:function(){
  //               return this.endLimit;
  //           },
  //           set:function(newValue){
  //             //   console.log(newValue);
  //               this.$emit('change-end-limit',newValue);
  //           }
  //       },
  //   },
  mounted() {
    var _this = this;

    Date.prototype.Format = function (fmt) {
      var o = {
        'M+': this.getMonth() + 1, //月份
        'd+': this.getDate(), //日
        'h+': this.getHours(), //小时
        'm+': this.getMinutes(), //分
        's+': this.getSeconds(), //秒
        'q+': Math.floor((this.getMonth() + 3) / 3), //季度
        S: this.getMilliseconds(), //毫秒
      };
      if (/(y+)/.test(fmt))
        fmt = fmt.replace(
          RegExp.$1,
          (this.getFullYear() + '').substr(4 - RegExp.$1.length),
        );
      for (var k in o)
        if (new RegExp('(' + k + ')').test(fmt))
          fmt = fmt.replace(
            RegExp.$1,
            RegExp.$1.length == 1
              ? o[k]
              : ('00' + o[k]).substr(('' + o[k]).length),
          );
      return fmt;
    };

    var startDate = new Date();
    startDate.setMonth(startDate.getMonth() - 1);
    startDate.setDate(1);

    _this.ComponentStartDate = startDate.Format('yyyy-MM-dd');
    _this.ComponentEndDate = new Date().Format('yyyy-MM-dd');
    _this.ComponentStartLimit = 0;
    _this.ComponentEndLimit = 10;

    $('.start-datepicker').datepicker({
      dateFormat: 'yy-mm-dd',
      onSelect: function (selectedDate, datePicker) {
        _this.ComponentStartDate = selectedDate;
      },
    });
    $('.end-datepicker').datepicker({
      dateFormat: 'yy-mm-dd',
      onSelect: function (selectedDate, datePicker) {
        _this.ComponentEndDate = selectedDate;
      },
    });
    // _this.ComponentStartDate = _this.startDate;
    // _this.ComponentEndDate = _this.endDate;
    // _this.ComponentStartLimit = _this.startLimit;
    // _this.ComponentEndLimit = _this.endLimit;

    _this
      .getData({
        url: $('base').attr('href') + _this.linkGetJsonPath,
        type: 'GET',
      })
      .then(function (result) {
        result = JSON.parse(result);
        _this.datas = result;
        _this.draw();
      })
      .catch((e) => {
        console.log(e);
      });
  },
};
</script>

<style lang="scss" scoped>
.pie-toolTip {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  position: absolute;
  display: none;
  width: auto;
  height: auto;
  background: none repeat scroll 0 0 white;
  border: 0 none;
  color: black;
  font: 12px sans-serif;
  padding: 5px;
  text-align: center;
}
</style>
