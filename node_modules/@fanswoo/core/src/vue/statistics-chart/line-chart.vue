<template>
  <div class="line-chart">
    <p>
      選擇日期
      <input
        type="text"
        name="startDate"
        class="start-datepicker"
        v-model="ComponentStartDate"
      />
      -
      <input
        type="text"
        name="endDate"
        class="end-datepicker"
        v-model="ComponentEndDate"
      />
      <button @click="reDraw" class="btn btn-primary" :disabled="isDisable">
        送出
      </button>
      <a
        v-if="hasExportPurview"
        :href="
          linkExportPath +
          '?startDate=' +
          ComponentStartDate +
          '&endDate=' +
          ComponentEndDate
        "
        class="btn btn-primary"
        :disabled="isDisable"
        >匯出</a
      >
    </p>
    <div class="legend4"></div>
  </div>
</template>

<script>
import * as d3 from 'd3';

export default {
  props: [
    'linkGetJsonPath',
    'linkExportPath',
    'startDate',
    'endDate',
    'hasExportPurview',
  ],
  data: function () {
    return {
      datas: [],
      ComponentStartDate: null,
      ComponentEndDate: null,
      isDisable: false,
    };
  },
  methods: {
    getData: function (options) {
      return new Promise(function (resolve, reject) {
        $.ajax(options).done(resolve).fail(reject);
      });
    },
    draw: function () {
      // massage the data
      if (this.datas.length == 0) {
        d3.select(this.$el)
          .append('div')
          .attr('class', 'empty')
          .append('p')
          .text('查無資料');
        return false;
      }

      var svg = d3
        .select(this.$el)
        .append('svg')
        .attr('width', 1000)
        .attr('height', 500);

      var margin = {
        top: 20,
        right: 20,
        bottom: 50,
        left: 60,
      };

      //定義寬高
      var width = +svg.attr('width') - margin.left - margin.right - 20;
      var height = +svg.attr('height') - margin.top - margin.bottom;

      var parseTime = d3.timeParse('%Y-%m-%d');

      var data = this.datas.map(function (d) {
        return {
          class: d.class,
          date: parseTime(d.date),
          value: d.value,
        };
      });

      var xScale = d3.scaleTime().rangeRound([0, width]);
      var yScale = d3.scaleLinear().rangeRound([height, 0]);

      // set the domain
      xScale.domain(
        d3.extent(data, function (d) {
          return d.date;
        }),
      );

      yScale
        .domain(
          d3.extent(data, function (d) {
            return d.value;
          }),
        )
        .nice();

      // create the outer g tag
      var g = svg
        .append('g')
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

      // add the x-axis
      var xAxis = d3
        .axisBottom(xScale)
        // .ticks(d3.timeMonth.every(1))
        .tickFormat(d3.timeFormat('%m-%d'));

      g.append('g')
        .attr('class', 'axis axis-x')
        .attr('transform', 'translate(0,' + height + ')')
        .call(xAxis);

      // add the y-axis
      var yAxis = d3.axisLeft(yScale);

      g.append('g')
        .attr('class', 'axis axis-y')
        // .append("text")
        .call(yAxis)
        .append('text')
        // .attr("transform", "rotate(-90)")
        .style('transform', 'translate(10px,0)')
        .attr('fill', '#000')
        .attr('text-anchor', 'start')
        .style('font-size', '12px')
        .text('次數');
      // .text("123");

      // create line for car
      var line = d3
        .line()
        .x(function (d) {
          return xScale(d.date);
        })
        .y(function (d) {
          return yScale(d.value);
        });

      //取得類別中的唯一值
      var color = d3.scaleOrdinal(['blue', 'red', 'green']);

      var classes = data
        .map(function (element, index) {
          return element.class;
        })
        .filter(function (element, index, arr) {
          return arr.indexOf(element) === index;
        });

      var svgLegned4 = d3
        .select('.legend4')
        .append('svg')
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')')
        .attr('width', 500)
        .attr('height', 50);

      var dataL = 0;
      var offset = 30;

      var legend4 = svgLegned4
        .selectAll('.legends4')
        .data(classes)
        .enter()
        .append('g')
        .attr('class', 'legends4')
        .attr('transform', function (d, i) {
          if (i === 0) {
            dataL = d.length * 15 /*字串長度單位乘以長度*/ + offset;
            return 'translate(0,0)';
          } else {
            var newdataL = dataL;
            dataL += d.length * 15 + offset;
            return 'translate(' + newdataL + ',0)';
          }
        });

      legend4
        .append('rect')
        .attr('x', 0)
        .attr('y', 0)
        .attr('width', 17)
        .attr('height', 17)
        .style('fill', function (d, i) {
          return color(i);
        });

      legend4
        .append('text')
        .attr('x', 20)
        .attr('y', 15)
        //.attr("dy", ".35em")
        .text(function (d, i) {
          return d;
        })
        .attr('class', 'textselected')
        .style('text-anchor', 'start')
        .style('font-size', 15);

      var tooltip = d3
        .select('body')
        .append('div')
        .attr('class', 'line-tooltip')
        .style('position', 'absolute')
        .style('opacity', 0.0);

      var title = tooltip.append('div').attr('class', 'title');

      var des = tooltip.selectAll('.des').data(classes).enter().append('div');

      var desColor = des.append('div').attr('class', 'des-color');

      var desText = des.append('div').attr('class', 'des-text');

      var vLine = svg
        .append('line')
        .attr('class', 'focusLine')
        .style('display', 'none');

      svg
        .append('rect')
        .attr('class', 'overlay')
        .attr('x', margin.left)
        .attr('y', margin.top)
        .attr('width', width)
        .attr('height', height)
        .style('fill', 'none')
        .style('pointer-events', 'all')
        .on('mouseover', function () {
          tooltip
            .style('left', d3.event.pageX + 'px')
            .style('top', d3.event.pageY + 'px')
            .style('opacity', 1.0);
          vLine.style('display', null);
        })
        .on('mouseout', function () {
          tooltip.style('opacity', 0.0);
          vLine.style('display', 'none');
        })
        .on('mousemove', mousemove);

      function mousemove() {
        // var data = data
        var mouseX = d3.mouse(this)[0] - margin.left;
        var mouseY = d3.mouse(this)[1] - margin.top;
        var x0 = xScale.invert(mouseX);
        var y0 = yScale.invert(mouseY);
        x0 = Math.round(x0);

        var time2date = new Date(x0);

        var bisect = d3.bisector((d) => d.date).left;
        var index = bisect(data, x0);

        // console.log(index,x0,time2date);
        // var date = x0;
        var time2date = new Date(x0);
        // var months = [
        //   "Jan",
        //   "Feb",
        //   "Mar",
        //   "Apr",
        //   "May",
        //   "Jun",
        //   "Jul",
        //   "Aug",
        //   "Sep",
        //   "Oct",
        //   "Nov",
        //   "Dec"
        // ];
        var months = [
          '01',
          '02',
          '03',
          '04',
          '05',
          '06',
          '07',
          '08',
          '09',
          '10',
          '11',
          '12',
        ];
        var year = time2date.getFullYear();
        var month = months[time2date.getMonth()];
        var date =
          time2date.getDate() < 10
            ? '0' + time2date.getDate()
            : time2date.getDate();
        // console.log(date);
        var values = [];

        for (var k = 0; k < classes.length; k++) {
          values[k] = {
            class: classes[k],
            value: data[index + k].value,
          };
          // console.log(classes[k],data[index + k].value,data[index + k],data,index,k);
        }

        title.html('<strong>' + year + '-' + month + '-' + date + '</strong>');
        desColor.style('background-color', function (d, i) {
          return color(i);
        });
        desText.html(function (d, i) {
          return (
            values[i].class + '\t' + '<strong>' + values[i].value + '</strong>'
          );
        });

        tooltip
          .style('left', d3.event.pageX - 100 + 'px')
          .style('top', d3.event.pageY + 20 + 'px');

        var vlx = xScale(data[index].date) + margin.left;

        vLine
          .attr('stroke', 'black')
          .attr('stroke-dasharray', '2')
          .attr('x1', vlx)
          .attr('y1', 20)
          .attr('x2', vlx)
          .attr('y2', height + 20);
      }

      for (var key in classes) {
        var newData = data.filter(function (d) {
          return d.class == classes[key];
        });

        // add the paths that represent the data
        var update = g.append('path').datum(newData);
        update
          .transition()
          .duration(500)
          .attr('fill', 'none')
          .attr('class', 'line line-car')
          .attr('stroke-linejoin', 'round')
          .attr('stroke-linecap', 'round')
          .attr('stroke-width', 1.5)
          .attr('stroke', color(key))
          .attr('d', line);
      }
    },
    reDraw: function () {
      var _this = this;
      _this.isDisable = !_this.isDisable;
      this.clearChart();
      let startDate = $('input[name="startDate"]').val();
      let endDate = $('input[name="endDate"]').val();
      // this.draw(startDate, endDate);

      this.getData({
        url: $('base').attr('href') + _this.linkGetJsonPath,
        data: {
          startDate: startDate,
          endDate: endDate,
        },
        type: 'GET',
      })
        .then(function (result) {
          result = JSON.parse(result);
          _this.datas = result;
          _this.draw();
          _this.isDisable = !_this.isDisable;
        })
        .catch((e) => {
          console.log(e);
        });
    },
    clearChart: function () {
      d3.select(this.$el).selectAll('svg').remove();

      d3.select(this.$el).selectAll('.empty').remove();
    },
  },
  mounted() {
    var _this = this;

    Date.prototype.Format = function (fmt) {
      var o = {
        'M+': this.getMonth() + 1, //月份
        'd+': this.getDate(), //日
        'h+': this.getHours(), //小时
        'm+': this.getMinutes(), //分
        's+': this.getSeconds(), //秒
        'q+': Math.floor((this.getMonth() + 3) / 3), //季度
        S: this.getMilliseconds(), //毫秒
      };
      if (/(y+)/.test(fmt))
        fmt = fmt.replace(
          RegExp.$1,
          (this.getFullYear() + '').substr(4 - RegExp.$1.length),
        );
      for (var k in o)
        if (new RegExp('(' + k + ')').test(fmt))
          fmt = fmt.replace(
            RegExp.$1,
            RegExp.$1.length == 1
              ? o[k]
              : ('00' + o[k]).substr(('' + o[k]).length),
          );
      return fmt;
    };

    var startDate = new Date();
    startDate.setMonth(startDate.getMonth() - 1);
    startDate.setDate(1);

    _this.ComponentStartDate = startDate.Format('yyyy-MM-dd');
    _this.ComponentEndDate = new Date().Format('yyyy-MM-dd');

    $('.start-datepicker').datepicker({
      dateFormat: 'yy-mm-dd',
      onSelect: function (selectedDate, datePicker) {
        _this.ComponentStartDate = selectedDate;
      },
    });
    $('.end-datepicker').datepicker({
      dateFormat: 'yy-mm-dd',
      onSelect: function (selectedDate, datePicker) {
        _this.ComponentEndDate = selectedDate;
      },
    });

    _this
      .getData({
        url: $('base').attr('href') + _this.linkGetJsonPath,
        type: 'GET',
      })
      .then(function (result) {
        result = JSON.parse(result);
        _this.datas = result;
        _this.draw();
      })
      .catch((e) => {
        console.log(e);
      });
  },
};
</script>

<style lang="scss" scoped>
.line-tooltip {
  font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
  min-width: 75px;
  background: none repeat scroll 0 0 white;
  border: 1px solid #000;
  font: 12px sans-serif;
  text-align: center;
  .title {
    border-bottom: 1px solid #000;
    text-align: center;
  }
  .des-color {
    width: 10px;
    height: 10px;
    float: left;
    margin: 1px 5px;
  }
  .des-text {
    display: inline;
  }
}
</style>
