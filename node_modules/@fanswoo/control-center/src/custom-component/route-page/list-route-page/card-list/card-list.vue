<template>
  <div>
    <template v-for="(ORMs, ORMsKey) in deckORMs" :key="ORMsKey">
      <b-card-group deck>
        <template v-for="(ORM, ORMKey) in ORMs" :key="ORM.id">
          <b-card v-if="ORM.opacityBox" class="opacity-box">
          </b-card>
          <b-card
            v-else
            @click="
              onClickCard(
                displayLinkTo(
                  ControlCenter.CardList.linkTo.to,
                  ORMsKey2ORMsKey(ORMsKey, ORMKey),
                ),
              )
            "
            no-body
            :class="{ checked: ORMCheckedIds.indexOf(ORM.id) > -1 }"
          >
            <template v-slot:header>
              <font-awesome-icon
                icon="check-circle"
                @click.stop="changeORMId(ORM.id)"
              />
            </template>
            <b-card-body>
              <b-card-title v-if="ControlCenter.CardList.title" title-tag="div">
                <div v-if="ControlCenter.CardList.title" class="title-left">
                  <ContentField
                    :type="ControlCenter.CardList.title.type"
                    @onChangeInputWidth="onChangeInputWidth"
                    @onORMCollectionUpdate="onORMCollectionUpdate"
                    :field="ControlCenter.CardList.title"
                    :ORM="ORM"
                    :value="
                      ControlCenter.CardList.title.value ||
                      getORMAttrValueByName(
                        ORMsKey2ORMsKey(ORMsKey, ORMKey),
                        ControlCenter.CardList.title.ORMAttr,
                      )
                    "
                    :href="
                      displayLinkTo(ControlCenter.CardList.title.href, ORMKey)
                    "
                    :to="displayLinkTo(ControlCenter.CardList.title.to, ORMKey)"
                  ></ContentField>
                </div>
                <div
                  v-if="ControlCenter.CardList.titleRight"
                  class="title-right"
                >
                  <ContentField
                    :type="ControlCenter.CardList.titleRight.type"
                    @onChangeInputWidth="onChangeInputWidth"
                    @onORMCollectionUpdate="onORMCollectionUpdate"
                    :field="ControlCenter.CardList.titleRight"
                    :ORM="ORM"
                    :value="
                      ControlCenter.CardList.titleRight.value ||
                      getORMAttrValueByName(
                        ORMsKey2ORMsKey(ORMsKey, ORMKey),
                        ControlCenter.CardList.titleRight.ORMAttr,
                      )
                    "
                    :href="
                      displayLinkTo(
                        ControlCenter.CardList.titleRight.href,
                        ORMKey,
                      )
                    "
                    :to="
                      displayLinkTo(
                        ControlCenter.CardList.titleRight.to,
                        ORMKey,
                      )
                    "
                  ></ContentField>
                </div>
              </b-card-title>
              <b-card-sub-title
                v-if="
                  ControlCenter.CardList.subtitle ||
                  ControlCenter.CardList.subtitleRight
                "
              >
                <div
                  v-if="ControlCenter.CardList.subtitle"
                  class="subtitle-left"
                >
                  <ContentField
                    :type="ControlCenter.CardList.subtitle.type"
                    @onChangeInputWidth="onChangeInputWidth"
                    @onORMCollectionUpdate="onORMCollectionUpdate"
                    :field="ControlCenter.CardList.subtitle"
                    :ORM="ORM"
                    :value="
                      ControlCenter.CardList.subtitle.value ||
                      getORMAttrValueByName(
                        ORMsKey2ORMsKey(ORMsKey, ORMKey),
                        ControlCenter.CardList.subtitle.ORMAttr,
                      )
                    "
                    :href="
                      displayLinkTo(
                        ControlCenter.CardList.subtitle.href,
                        ORMKey,
                      )
                    "
                    :to="
                      displayLinkTo(ControlCenter.CardList.subtitle.to, ORMKey)
                    "
                  ></ContentField>
                </div>
                <div
                  v-if="ControlCenter.CardList.subtitleRight"
                  class="subtitle-right"
                >
                  <ContentField
                    :type="ControlCenter.CardList.subtitleRight.type"
                    @onChangeInputWidth="onChangeInputWidth"
                    @onORMCollectionUpdate="onORMCollectionUpdate"
                    :field="ControlCenter.CardList.subtitleRight"
                    :ORM="ORM"
                    :value="
                      ControlCenter.CardList.subtitleRight.value ||
                      getORMAttrValueByName(
                        ORMsKey2ORMsKey(ORMsKey, ORMKey),
                        ControlCenter.CardList.subtitleRight.ORMAttr,
                      )
                    "
                    :href="
                      displayLinkTo(
                        ControlCenter.CardList.subtitleRight.href,
                        ORMKey,
                      )
                    "
                    :to="
                      displayLinkTo(
                        ControlCenter.CardList.subtitleRight.to,
                        ORMKey,
                      )
                    "
                  ></ContentField>
                </div>
              </b-card-sub-title>
              <b-card-text
                v-if="ControlCenter.CardList.bodyText"
                v-html="
                  getORMAttrValueByName(
                    ORMsKey2ORMsKey(ORMsKey, ORMKey),
                    ControlCenter.CardList.bodyText.ORMAttr,
                  )
                "
              ></b-card-text>
            </b-card-body>
            <b-list-group
              v-if="
                ControlCenter &&
                ControlCenter.CardList &&
                ControlCenter.CardList.SupplementBox &&
                ControlCenter.CardList.SupplementBox.fields &&
                Object.keys(ControlCenter.CardList.SupplementBox.fields)
                  .length > 0
              "
              flush
            >
              <template
                v-for="(field, fieldKey) in ControlCenter.CardList.SupplementBox
                  .fields"
                :key="fieldKey"
              >
                <b-list-group-item>
                  <ContentField
                    :type="field.type"
                    @onChangeInputWidth="onChangeInputWidth"
                    @onORMCollectionUpdate="onORMCollectionUpdate"
                    :field="field"
                    :ORM="ORM"
                    :value="
                      field.value ||
                      getORMAttrValueByName(
                        ORMsKey2ORMsKey(ORMsKey, ORMKey),
                        field.ORMAttr,
                      )
                    "
                    :href="displayLinkTo(field.href, ORMKey)"
                    :to="displayLinkTo(field.to, ORMKey)"
                  ></ContentField>
                </b-list-group-item>
              </template>
            </b-list-group>
            <template
              v-slot:footer
              v-if="
                ControlCenter &&
                ControlCenter.CardList &&
                ControlCenter.CardList.EditField &&
                ControlCenter.CardList.EditField.fields &&
                Object.keys(ControlCenter.CardList.EditField.fields).length > 0
              "
            >
              <div v-if="ControlCenter.CardList.footerText" class="footer-text">
                <ContentField
                  :type="ControlCenter.CardList.footerText.type"
                  @onChangeInputWidth="onChangeInputWidth"
                  @onORMCollectionUpdate="onORMCollectionUpdate"
                  :field="ControlCenter.CardList.footerText"
                  :ORM="ORM"
                  :value="
                    ControlCenter.CardList.footerText.value ||
                    getORMAttrValueByName(
                      ORMsKey2ORMsKey(ORMsKey, ORMKey),
                      ControlCenter.CardList.footerText.ORMAttr,
                    )
                  "
                  :href="
                    displayLinkTo(
                      ControlCenter.CardList.footerText.href,
                      ORMKey,
                    )
                  "
                  :to="
                    displayLinkTo(ControlCenter.CardList.footerText.to, ORMKey)
                  "
                ></ContentField>
              </div>
              <div class="edit-field" @click.stop>
                <template
                  v-for="(field, fieldKey) in ControlCenter.CardList.EditField
                    .fields"
                  :key="fieldKey"
                >
                  <template
                    v-if="
                      field.shouldDisplay == undefined ||
                      field.shouldDisplay == null ||
                      ORMs[ORMKey][field.shouldDisplay] == true
                    "
                  >
                    <template v-if="field.type == 'LinkTo'">
                      <RouterLinkEditField
                        v-if="field.ifNotOnlyTrashed && !onlyTrashed"
                        :to="
                          displayLinkTo(
                            field.to,
                            ORMsKey2ORMsKey(ORMsKey, ORMKey),
                          )
                        "
                        :fontAwesomeIcon="field.fontAwesomeIcon"
                        :title="field.text"

                      />
                    </template>
                    <template v-else-if="field.type == 'InputButton'"
                              :key="fieldKey">
                      <ButtonEditField
                        v-if="
                          (field.ifOnlyTrashed && onlyTrashed) ||
                          (field.ifNotOnlyTrashed && !onlyTrashed)
                        "
                        :name="fieldKey"
                        :title="field.text"
                        :action="field.action"
                        :value="
                          getORMAttrValueByName(
                            ORMsKey2ORMsKey(ORMsKey, ORMKey),
                            field.ORMAttrName,
                          )
                        "
                        :confirm="field.confirm"
                        :fontAwesomeIcon="field.fontAwesomeIcon"
                      />
                    </template>
                  </template>
                </template>
              </div>
            </template>
          </b-card>
        </template>
      </b-card-group>
    </template>
    <SearchStatus
      :ORMs="ORMs"
      :searching="searching"
      :canSearchMore="canSearchMore"
      @onORMCollectionPush="onORMCollectionPush"
    ></SearchStatus>
  </div>
</template>

<script setup lang="ts">
import { ref, watch, onMounted, getCurrentInstance } from 'vue';
import RouterLinkEditField from '@fanswoo/control-center/custom-component/list-control-center/edit-field/base/router-link-edit-field.vue';
import ButtonEditField from '@fanswoo/control-center/custom-component/list-control-center/edit-field/base/button-edit-field.vue';
import ListFieldUtil from '@fanswoo/control-center/custom-component/route-page/list-route-page/list-field-util.vue';
import ContentField from '@fanswoo/control-center/custom-component/route-page/list-route-page/content-field.vue';
import SearchStatus from '@fanswoo/control-center/custom-component/route-page/list-route-page/search-status.vue';

interface IORM {
  id?: number | null;
  opacityBox: boolean;
}

const props = defineProps({
  scrollFixed: {
    type: Boolean,
    default: false,
  },
  controlBarHeight: {
    type: Number,
    default: 0,
  },
  ControlCenter: {
    type: Object,
    default: () => ({}),
  },
  ORMs: {
    type: Array,
    default: () => [],
  },
  ORMCheckedIds: {
    type: Array,
    default: () => [],
  },
  onlyTrashed: {
    type: Boolean,
    default: false,
  },
  searching: {
    type: Boolean,
    default: false,
  },
  canSearchMore: {
    type: String,
    default: '',
  },
});

const cardColumnCount = ref(0);
const deckORMs = ref<IORM[][]>([]);

const resetDeckORMs = () => {
  const newDeckORMs: IORM[][] = [];
  for (let i = 0; i < props.ORMs.length; i += cardColumnCount.value) {
    newDeckORMs.push(props.ORMs.slice(i, i + cardColumnCount.value));
  }

  if (
    newDeckORMs.length > 0 &&
    newDeckORMs[newDeckORMs.length - 1].length < cardColumnCount.value
  ) {
    const pushCount = cardColumnCount.value - newDeckORMs[newDeckORMs.length - 1].length;
    for (let i = 0; i < pushCount; i++) {
      const ORM = { id: null, opacityBox: true };
      newDeckORMs[newDeckORMs.length - 1].push(ORM);
    }
  }
  deckORMs.value = newDeckORMs;
};

watch(props.ORMs, () => {
  resetDeckORMs();
});

watch(cardColumnCount, () => {
  resetDeckORMs();
});

const resetCardColumnCount = () => {
  const bodyContentPageWidth = document.querySelector('.body-content-page')?.clientWidth;
  if (bodyContentPageWidth >= 1680) {
    cardColumnCount.value = 6;
  } else if (bodyContentPageWidth >= 1366) {
    cardColumnCount.value = 5;
  } else if (bodyContentPageWidth >= 1024) {
    cardColumnCount.value = 4;
  } else if (bodyContentPageWidth >= 800) {
    cardColumnCount.value = 3;
  } else {
    cardColumnCount.value = 2;
  }
};

const vueInstance = getCurrentInstance();

const onWindowsResize = _.debounce(() => {
  resetCardColumnCount();
}, 300);

onMounted(() => {
  resetCardColumnCount();
  const observer = new ResizeObserver(onWindowsResize);
  const bodyContentPage = document.querySelector('.body-content-page');
  if (bodyContentPage) {
    observer.observe(bodyContentPage);
  }
});

const onClickCard = (url) => {
  vueInstance.proxy.$router.push(url);
};

const ORMsKey2ORMsKey = (ORMsKey, ORMKey) => {
  return ORMsKey * cardColumnCount.value + ORMKey;
};
</script>

