<template>
  <span @click.stop>
    <component
      :is="type"
      v-if="type !== 'LinkTo' && type !== 'LocationHref'"
      v-bind="field"
      :ORM="ORM"
      :value="value"
      @onORMCollectionUpdate="onORMCollectionUpdate($event, ORM)"
    ></component>
    <component
      :is="type"
      v-if="type == 'LinkTo'"
      v-bind="field"
      :ORM="ORM"
      :value="value"
      :to="to"
      @onORMCollectionUpdate="onORMCollectionUpdate($event, ORM)"
    ></component>
    <component
      :is="type"
      v-if="type == 'LocationHref'"
      v-bind="field"
      :ORM="ORM"
      :value="value"
      :href="href"
      @onORMCollectionUpdate="onORMCollectionUpdate($event, ORM)"
    ></component>
  </span>
</template>

<script setup lang="ts">
import { ref, inject, getCurrentInstance } from 'vue';
import { ComponentLoader } from '@fanswoo/component-loader/main';
import _ from 'lodash';

const props = defineProps({
  type: {
    type: String,
    default: '',
  },
  ORM: {
    type: Object,
    default: () => ({}),
  },
  field: {
    type: [Array, Object],
    default: () => ({}),
  },
  value: {
    type: [Number, String],
    default: '',
  },
  href: {
    type: String,
    default: '',
  },
  to: {
    type: [Boolean, String],
    default: '',
  },
});

const urlRootPath = inject('urlRootPath');
const emits = defineEmits(['onORMCollectionUpdate']);

const Loader = ComponentLoader.getInstance();
const vueInstance = getCurrentInstance();

if(!vueInstance.proxy.$.components) {
  vueInstance.proxy.$.components = [];
}
_.merge(vueInstance.proxy.$.components, Loader.loadComponents([
  {
    pageName: urlRootPath,
    themeName: 'listCustomComponent',
    typeName: 'tableField',
  },
]));

const onORMCollectionUpdate = (payload, ORM) => {
  emits('onORMCollectionUpdate', {
    target: payload.target,
    ORM,
  });
};

// Assuming _.merge() or a similar operation might be needed to merge components dynamically.
// This operation is complex in Vue 3 without direct access to this.$options.
// A recommended approach would be to setup dynamic component loading within the template or setup a global component registry.
</script>

