<template>
  <select
    v-if="displayBatchButton"
    class="batch-button"
    @change="change($event)"
    v-model="batchSelectValueDefault"
  >
    <option value="">{{ batchSelectTextData }}</option>
    <template v-for="(option, index) in batchSelectOptions" :key="index">
      <option
        v-if="
          (onlyTrashed && option.ifOnlyTrashed) ||
          (!onlyTrashed && option.ifNotOnlyTrashed)
        "
        :text="option.text"
        :displayCount="option.displayCount"
        :action="option.action"
        :confirm="option.confirm"
        :locationHref="option.locationHref"
        :linkTo="option.linkTo"
      >
        {{ displayTexts[index] }}
      </option>
    </template>
  </select>
</template>

<script>
import { Message } from '@fanswoo/message/main';

export default {
  props: [
    'batchSelectText',
    'batchSelectOptions',
    'onlyTrashed',
    'totalCount',
    'selectedCount',
    'ORMCheckedIds',
  ],
  data: () => {
    return {
      batchSelectValueDefault: '',
      // displayBatchButton: false
    };
  },
  computed: {
    displayBatchButton: function () {
      if (this.totalCount == 0) {
        return false;
      }

      for (let key in this.batchSelectOptions) {
        if (this.onlyTrashed && this.batchSelectOptions[key].ifOnlyTrashed) {
          return true;
        } else if (
          !this.onlyTrashed &&
          this.batchSelectOptions[key].ifNotOnlyTrashed
        ) {
          return true;
        }
      }

      return false;
    },
    batchSelectTextData: {
      cache: false,
      get: function () {
        var text = this.batchSelectText;

        if (!this.totalCount) {
          text = text + ' ( ' + this.selectedCount + ' ) ';
        } else if (this.totalCount !== undefined) {
          text =
            text + ' ( ' + this.selectedCount + ' / ' + this.totalCount + ' ) ';
        }

        return text;
      },
    },
    displayTexts: {
      cache: false,
      get: function () {
        let displayTexts = [];

        for (let key in this.batchSelectOptions) {
          var text = this.batchSelectOptions[key].text;
          var displayCount = this.batchSelectOptions[key].displayCount;

          if (displayCount == 'selected') {
            text = text + ' ( ' + this.selectedCount + ' ) ';
          } else if (displayCount == 'total' && this.totalCount !== undefined) {
            text = text + ' ( ' + this.totalCount + ' ) ';
          }

          displayTexts[key] = text;
        }

        return displayTexts;
      },
    },
  },
  methods: {
    async change(event) {
      this.batchSelectValueDefault = '';

      let optionAttr = event.target[event.target.selectedIndex].attributes;
      let locationHref;
      let confirmMessage;
      let action;
      let linkTo;

      if (optionAttr.locationHref) {
        locationHref = optionAttr.locationHref.value;
      }

      if (optionAttr.confirm) {
        confirmMessage = optionAttr.confirm.value;
      }

      if (optionAttr.action) {
        action = optionAttr.action.value;
      }

      if (optionAttr.linkTo) {
        linkTo = optionAttr.linkTo.value;
      }

      if (confirmMessage && !confirm(confirmMessage)) {
        return false;
      }

      if (locationHref) {
        location.href = locationHref + '?ids=' + this.ORMCheckedIds;
      } else if (linkTo) {
        this.$router.push({
          path: linkTo,
          query: {
            ids: this.ORMCheckedIds.join(','),
          },
        });
        // this.$router.push( linkTo + '?ids=' + this.ORMCheckedIds);
      } else if (action) {
        let response;
        try {
          response = await axios.post(action, { ids: this.ORMCheckedIds });
        } catch (error) {
          console.error(error);
        }

        let data = response.data;

        const message = Message.getInstance();
        message.show({
          text: data.text,
          second: data.second,
          downloadUrl: data.downloadUrl,
        });

        if (data.syncORMs && data.syncORMs.ids && data.syncORMs.path) {
          this.$store.commit('RoutePage/setSyncORMs', {
            ids: data.syncORMs.ids,
            path: data.syncORMs.path,
          });
        }
      }
    },
  },
  mounted: function () {},
};
</script>
