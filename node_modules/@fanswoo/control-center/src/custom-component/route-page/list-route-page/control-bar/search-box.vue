<template>
  <div
    :class="{ 'setting-box': true, fixed: scrollFixed }"
    :style="{ display: searchBoxDisplay }"
  >
    <template v-for="(field, key) in searchSettingFields" :key="key">
      <component
        :is="field.type"
        class="input-area"
        v-bind="field"
        :value="searchSettingFields[key].value"
        @onChange="changeResult"
      />
    </template>
  </div>
</template>

<script setup lang="ts">
import { ref, onBeforeMount, onBeforeUnmount, inject, getCurrentInstance, onActivated, onMounted } from 'vue';
import { ComponentLoader } from '@fanswoo/component-loader/main';
import _ from 'lodash';

const props = defineProps({
  searchSettingFields: {
    type: Object,
    default: () => ({}),
  },
  scrollFixed: {
    type: [String, Number, Boolean],
    default: null,
  }
});

const searchBoxDisplay = ref('none');
const urlRootPath = inject('urlRootPath');
const vueInstance = getCurrentInstance();

const Loader = ComponentLoader.getInstance();
if(!vueInstance.proxy.$.components) {
  vueInstance.proxy.$.components = [];
}
_.merge(vueInstance.proxy.$.components, Loader.loadComponents([
  {
    pageName: urlRootPath,
    themeName: 'listCustomComponent',
    typeName: 'searchBox',
  },
]));

const settingButtonClick = () => {
  if (searchBoxDisplay.value == 'none') {
    searchBoxDisplay.value = 'block';
  } else {
    searchBoxDisplay.value = 'none';
  }
}

const changeResult = (payload) => {
  for (const key in props.searchSettingFields) {
    if (props.searchSettingFields[key].inputName === payload.inputName) {
      props.searchSettingFields[key].value = payload.value;
      vueInstance.proxy.$emit('changeResult', {
        key: key,
        text: props.searchSettingFields[key].value,
        value: props.searchSettingFields[key].value,
      });
    }
  }
};

const onCloseSearchBox = (event) => {
  if (
    $(event.target).hasClass('setting-box') ||
    $(event.target).parents('.setting-box').length > 0
  ) {
    searchBoxDisplay.value = 'block';
  } else if (!$(event.target).hasClass('setting-button')) {
    searchBoxDisplay.value = 'none';
  }
  event.stopPropagation();
};

onBeforeMount(() => {
  document.addEventListener('click', onCloseSearchBox, false);
});

onBeforeUnmount(() => {
  document.removeEventListener('click', onCloseSearchBox);
});

defineExpose({
  settingButtonClick
});
</script>

