<template>
  <div class="body-content-page">
    <PageNavigation
      :title="title"
      :subtitle="subtitle"
      :activeName="pageNavigation.activeName"
      :showFixedPageNavigation="pageNavigation.showFixedPageNavigation"
      :navItems="pageNavigation.navItems"
    />
    <ControlBar
      v-if="ControlCenter"
      :ControlCenter="ControlCenter"
      :onlyTrashed="onlyTrashed"
      :totalCount="totalCount"
      :selectedCount="selectedCount"
      :searchSettingFields="searchSettingFields"
      :ORMCheckedIds="ORMCheckedIds"
      :listComponents="listComponents"
      @changeResult="ORMCollectionResult"
    />
    <div class="list-content">
      <CardList
        v-if="
          ControlCenter &&
          ControlCenter.CardList &&
          searchSettingFields.listComponent &&
          searchSettingFields.listComponent.value == 'CardList'
        "
        :scrollFixed="scrollFixed"
        :controlBarHeight="controlBarHeight"
        :ControlCenter="ControlCenter"
        :ORMs="ORMs"
        :ORMCheckedIds="ORMCheckedIds"
        :onlyTrashed="onlyTrashed"
        :searching="searching"
        :canSearchMore="canSearchMore"
        @onORMCollectionPush="ORMCollectionPush"
        @onORMCollectionUpdate="ORMCollectionUpdate"
      />
      <TableList
        v-if="
          ControlCenter &&
          ControlCenter.TableList &&
          searchSettingFields.listComponent &&
          searchSettingFields.listComponent.value == 'TableList'
        "
        :scrollFixed="scrollFixed"
        :controlBarHeight="controlBarHeight"
        :ControlCenter="ControlCenter"
        :ORMs="ORMs"
        :ORMCheckedIds="ORMCheckedIds"
        :onlyTrashed="onlyTrashed"
        :searching="searching"
        :canSearchMore="canSearchMore"
        @onORMCollectionPush="ORMCollectionPush"
        @onORMCollectionUpdate="ORMCollectionUpdate"
      />
    </div>
  </div>
</template>

<script lang="ts">
import { watch, ref, computed, inject, getCurrentInstance, onMounted } from 'vue';
import { Message } from '@fanswoo/message/main';
import ControlBar from '@fanswoo/control-center/custom-component/route-page/list-route-page/control-bar/control-bar.vue';
import TableList from '@fanswoo/control-center/custom-component/route-page/list-route-page/table-list/table-list.vue';
import CardList from '@fanswoo/control-center/custom-component/route-page/list-route-page/card-list/card-list.vue';
import ORMCollectionConstructor from '@fanswoo/control-center/core/orm-collection';
import CustomRoutePage from '@fanswoo/control-center/core/custom-route-page.vue';
import PageNavigation from '@fanswoo/control-center/layouts/page-navigation.vue';
import { ComponentLoader } from '@fanswoo/component-loader/main';
import _ from 'lodash';
import { useStore } from '@/control-center/store/control-center-store';

export default {
  mixins: [CustomRoutePage],
  components: {
    ControlBar,
    TableList,
    CardList,
    PageNavigation,
  },
  props: {
    listComponents: {
      type: Object,
      default() {
        return {};
      },
    },
    title: {
      type: String,
      default: '',
    },
    subtitle: {
      type: String,
      default: '',
    },
    tableEl: {
      type: String,
      default: '',
    },
    linkGetJsonPath: {
      type: String,
      default: '',
    },
    linkSetJsonPath: {
      type: String,
      default: '',
    },
    ControlCenter: {
      type: Object,
      default() {
        return {};
      },
    },
    searchSettingFields: {
      type: Object,
      default() {
        return {};
      },
    },
    pageNavigation: {
      type: Object,
      default() {
        return {};
      },
    },
  },
  setup(props) {
    const vueInstance = getCurrentInstance();
    const store = useStore();
    const displayType = ref('');
    const ORMCollection = ref({});
    const totalCount = ref(0);
    const searching = ref(false);
    const canSearchMore = ref('');
    const onlyTrashed = ref(false);
    const ORMs = ref([]);
    const ORMCheckedIds = ref([]);
    const scrollFixed = ref(false);
    const controlBarHeight = ref(0);
    const isRouteChangeToActivated = ref(false);

    const syncORMs = computed(() => {
      return store.state.RoutePage.syncORMs;
    });
    const syncORM = computed(() => {
      return store.state.RoutePage.syncORM;
    });
    const urlRootPath = inject('urlRootPath');

    const setSyncORM = (payload) => {
      store.commit('RoutePage/setSyncORM', payload);
    };

    watch(() => syncORMs.value, () => {
      onSyncORMs();
    });

    const selectedCount = computed(() => {
      return ORMCheckedIds.value.length;
    });

    const ORMCollectionResult = async(payload) => {
      if (payload && payload.key && props.searchSettingFields[payload.key]) {
        props.searchSettingFields[payload.key] = _.clone(
          props.searchSettingFields[payload.key],
        );
        props.searchSettingFields[payload.key].text = payload.text;
        props.searchSettingFields[payload.key].value = payload.value;
      }

      if (searching.value === true) {
        return false;
      }

      searching.value = true;
      ORMs.value = [];

      await ORMCollection.value.result({
        select: getFormSelect(),
      });

      ORMs.value = ORMCollection.value.getORMs();
      searching.value = ORMCollection.value.searching;
      canSearchMore.value = ORMCollection.value.canSearchMore;
      totalCount.value = ORMCollection.value.totalCount;
      onlyTrashed.value = ORMCollection.value.onlyTrashed;

      const response = ORMCollection.value.getResponse();

      if (response.type === 'message') {
        const message = Message.getInstance();
        message.show(
          response.text,
          response.second,
          response.url,
          response.script,
        );
      }

      $('html,body').animate(
        {
          scrollTop: 0,
        },
        500,
      );

      saveListControlCenterRequestCookie(getFormSelect());
      // responsiveTable();

      return true;
    };

    const ORMCollectionSync = async(arg) => {
      await ORMCollection.value.sync({
        id: arg.id,
        key: arg.key,
        select: getFormSelect(),
      });
      ORMs.value = ORMCollection.value.getORMs();

      ORMCheckedIds.value = _.filter(ORMCheckedIds.value, (id: number) => {
        for (let i = 0; i < ORMs.value.length; i += 1) {
          if (ORMs.value[i].id === id) {
            return true;
          }
        }
        return false;
      });
    };

    const ORMCollectionPrepend = async(arg) => {
      await ORMCollection.value.prepend({
        id: arg.id,
        select: getFormSelect(),
      });
      ORMs.value = ORMCollection.value.getORMs();
    };

    const ORMCollectionPush = async() => {
      if (searching.value === true || canSearchMore.value === 'no') {
        return false;
      }

      const select = getFormSelect();

      select.idNotIn = [];

      for (let i = 0; i < ORMs.value.length; i += 1) {
        const { id } = ORMs.value[i];
        select.idNotIn.push(id);
      }

      searching.value = true;

      await ORMCollection.value.push({
        select,
      });

      const response = ORMCollection.value.getResponse();

      if (response.data.type === 'message') {
        const message = Message.getInstance();
        message.show(
          response.data.text,
          response.data.second,
          response.data.url,
          response.data.script,
        );
      }

      searching.value = ORMCollection.value.searching;
      canSearchMore.value = ORMCollection.value.canSearchMore;

      return true;
    };

    const ORMCollectionUpdate = async(payload) => {
      const { target, ORM } = payload;

      const $this = $(target);

      $this.blur();

      const select = {
        id: ORM.id,
      };
      select[$this.attr('name')] = $this.val();

      const status = await ORMCollection.value.update({
        select,
        ORM,
      });

      const response = ORMCollection.value.getResponse();

      if (response.data.type === 'message') {
        const message = Message.getInstance();
        message.show(
          response.data.text,
          response.data.second,
          response.data.url,
          response.data.script,
        );

        if (
          response.data.syncORM &&
          response.data.syncORM.id &&
          response.data.syncORM.path
        ) {
          setSyncORM({
            id: response.data.syncORM.id,
            path: response.data.syncORM.path,
          });
        }
      }

      if (status) {
        const ORMKey = getORMKey(select.id);
        ORMCollectionSync({
          id: select.id,
          key: ORMKey,
        });
      } else {
        $this.focus();
      }
    };

    const getFormSelect = () => {
      const data = {
        idNotIn: [],
      };

      const fieldKeys = Object.keys(props.searchSettingFields);
      for (let i = 0; i < fieldKeys.length; i += 1) {
        const key = fieldKeys[i];
        if (props.searchSettingFields[key].value !== null) {
          data[props.searchSettingFields[key].inputName] =
            props.searchSettingFields[key].value;
        }
      }

      return data;
    };

    const saveListControlCenterRequestCookie = async(data) => {
      let jsonPathArr = props.linkGetJsonPath.split('/');
      jsonPathArr = jsonPathArr.slice(0, -1);
      jsonPathArr.push('saveListControlCenterRequestCookie');
      const saveUrl = jsonPathArr.join('/');

      try {
        await axios.post(saveUrl, data);
      } catch (error) {
        if (error instanceof Error) {
          console.error(error);
        }
      }
    };

    const getORMKey = (id) => {
      for (let i = 0; i < ORMs.value.length; i += 1) {
        if (id === ORMs.value[i].id) {
          return i;
        }
      }

      return null;
    };

    const onSyncORMs = async() => {
      if (
        syncORMs.value &&
        syncORMs.value.ids &&
        syncORMs.value.path === urlRootPath.value
      ) {
        const ORMIds = syncORMs.value.ids;

        for (let i = 0; i < ORMIds.length; i += 1) {
          const ORMId = ORMIds[i];
          const ORMKey = getORMKey(ORMId);

          if (ORMKey !== null) {
            await ORMCollectionSync({
              id: ORMId,
              key: ORMKey,
            });
          } else {
            await ORMCollectionPrepend({
              id: ORMId,
            });
          }
        }
      }
    };

    const bindEvent = () => {
      window.addEventListener('scroll', onScrollDocument, true);
    };

    const onBeforeRouteUpdate = () => {
      window.removeEventListener('scroll', onScrollDocument);
    };

    const onScrollDocument = () => {
      if (
        $(window).scrollTop() !== 0 &&
        Math.ceil($(window).scrollTop() + $(window).height() + 300) >=
          Math.ceil($(document).height())
      ) {
        ORMCollectionPush();
      }

      const scrollTop = $(document).scrollTop();

      if (
        ($(window).width() >= 1024 && scrollTop >= 80) ||
        ($(window).width() < 1024 && scrollTop >= 16)
      ) {
        scrollFixed.value = true;
        const scrollLeft = $(
          '.table-content:not(.table-head-fixed) .table-responsive',
        ).scrollLeft();
        $('.table-content.table-head-fixed .table-responsive').scrollLeft(
          scrollLeft,
        );
        setTimeout(() => {
          if ($(window).width() >= 768) {
            controlBarHeight.value = $('.control-bar').height() + 60;
          } else {
            controlBarHeight.value = $('.control-bar').height() + 110;
          }
        });
      } else {
        scrollFixed.value = false;
      }
    };

    const createORMCollection = () => {
      ORMCollection.value = new ORMCollectionConstructor({
        getJsonPath: props.linkGetJsonPath,
        setJsonPath: props.linkSetJsonPath,
      });
    };

    const beforeRouteUpdate = (to, from, next) => {
      this.isRouteChangeToActivated = true;
      next();
    };

    const awaitRouteChangeToActivated = async() => {
      if (isRouteChangeToActivated.value === true) {
        isRouteChangeToActivated.value = false;
        return true;
      }
      return false;
    };

    const activated = async() => {
      await awaitRouteChangeToActivated();

      bindEvent();
      onSyncORMs();
    };

    const Loader = ComponentLoader.getInstance();
    if(!vueInstance.proxy.$.components) {
      vueInstance.proxy.$.components = [];
    }
    _.merge(vueInstance.proxy.$.components, Loader.loadComponents([
      {
        pageName: urlRootPath.value,
        themeName: 'layout',
        typeName: 'layout',
      },
    ]));

    onMounted(() => {
      createORMCollection();
      ORMCollectionResult({});
      bindEvent();
    });

    return {
      ORMCollectionResult,
      ORMCollectionSync,
      ORMCollectionPrepend,
      ORMCollectionPush,
      ORMCollectionUpdate,
      onBeforeRouteUpdate,
      activated,
      createORMCollection,
      bindEvent,
      beforeRouteUpdate,
      canSearchMore,
      controlBarHeight,
      displayType,
      onlyTrashed,
      ORMCheckedIds,
      ORMs,
      searching,
      scrollFixed,
      selectedCount,
      syncORM,
      syncORMs,
      totalCount,
    };
  },
}
</script>
