<template>
  <b-tbody>
    <template v-for="(ORM, ORMKey) in ORMs" :key="ORM.id">
      <b-tr
        v-if="ORM && ORM.id"
        v-cloak
        :id="ORM.id"
        :class="{ checked: ORMCheckedIds.indexOf(ORM.id) > -1 }"
      >
        <b-th
          v-if="
            ControlCenter.batchSelectOptions &&
            Object.keys(ControlCenter.batchSelectOptions).length > 0
          "
          scope="row"
          style="width: 30px"
          class="first-td"
          @click.self="changeORMId(ORM.id)"
        >
          <b-form-checkbox v-if="hideIds" size="lg" />
          <b-form-checkbox
            v-else
            name="ids[]"
            :value="ORM.id"
            size="lg"
            :checked="ORMCheckedIds.indexOf(ORM.id) > -1"
            @change="changeORMId(ORM.id)"
          />
        </b-th>
        <template v-if="ControlCenter && ControlCenter.TableList">
          <template v-for="(field, fieldKey) in ControlCenter.TableList.fields" :key="fieldKey">
            <b-td
              v-if="field.title"
              :style="[
                { minWidth: field.minWidth + 'px' },
                { maxWidth: field.maxWidth + 'px' },
                field.maxWidth ? { whiteSpace: 'normal' } : {},
              ]"
              :class="{
                'first-td':
                  fieldKey == 0 &&
                  Object.keys(ControlCenter.batchSelectOptions).length == 0,
              }"
              @click.self="changeORMId(ORM.id)"
            >
              <ContentField
                :type="field.type"
                :field="filterField(field)"
                :ORM="ORM"
                :value="field.value || getORMAttrValue(ORMKey, fieldKey)"
                :href="displayLinkTo(field.href, ORMKey)"
                :to="displayLinkTo(field.to, ORMKey)"
                @onORMCollectionUpdate="onORMCollectionUpdate"
              />
            </b-td>
          </template>
        </template>
        <b-td
          v-if="
            ControlCenter &&
            ControlCenter.TableList &&
            ControlCenter.TableList.EditField &&
            ControlCenter.TableList.EditField.fields &&
            Object.keys(ControlCenter.TableList.EditField.fields).length > 0
          "
          class="edit-field"
          @click.self="changeORMId(ORM.id)"
        >
          <template
            v-for="(field, fieldKey) in ControlCenter.TableList.EditField
              .fields"
            :key="fieldKey"
          >
            <template
              v-if="
                field.shouldDisplay == undefined ||
                field.shouldDisplay == null ||
                getORMAttrValueByName(ORMKey, field.shouldDisplay)
              "
              :key="fieldKey"
            >
              <template v-if="field.type == 'LinkTo'">
                <RouterLinkEditField
                  v-if="field.ifNotOnlyTrashed && !onlyTrashed"
                  :to="displayLinkTo(field.to, ORMKey)"
                  :fontAwesomeIcon="field.fontAwesomeIcon"
                  :title="field.text"
                />
              </template>
              <template v-else-if="field.type == 'InputButton'">
                <ButtonEditField
                  v-if="
                    (field.ifOnlyTrashed && onlyTrashed) ||
                    (field.ifNotOnlyTrashed && !onlyTrashed)
                  "
                  :name="fieldKey"
                  :title="field.text"
                  :action="field.action"
                  :value="getORMAttrValueByName(ORMKey, field.ORMAttrName)"
                  :confirm="field.confirm"
                  :fontAwesomeIcon="field.fontAwesomeIcon"
                />
              </template>
            </template>
          </template>
        </b-td>
      </b-tr>
    </template>
  </b-tbody>
</template>

<script lang="ts">
import { inject, ref, onMounted, getCurrentInstance, onActivated } from 'vue';
import RouterLinkEditField from '@fanswoo/control-center/custom-component/list-control-center/edit-field/base/router-link-edit-field.vue';
import ButtonEditField from '@fanswoo/control-center/custom-component/list-control-center/edit-field/base/button-edit-field.vue';
import ContentField from '@fanswoo/control-center/custom-component/route-page/list-route-page/content-field.vue';
import { ComponentLoader } from '@fanswoo/component-loader/main';
import _ from 'lodash';
import ListFieldUtil from '@fanswoo/control-center/custom-component/route-page/list-route-page/list-field-util.vue';

export default {
  components: {
    RouterLinkEditField,
    ButtonEditField,
    ContentField,
  },
  props: {
    ControlCenter: {
      type: Object,
      default: () => ({}),
    },
    ORMs: {
      type: Array,
      default: () => ([]),
    },
    onlyTrashed: {
      type: Boolean,
      default: false,
    },
    ORMCheckedIds: {
      type: Array,
      default: () => ([]),
    },
    hideIds: {
      type: Boolean,
      default: false,
    },
  },
  setup(props, ctx) {
    const { emit } = ctx;
    const urlRootPath = inject('urlRootPath');

    const vueInstance = getCurrentInstance();
    const onORMCollectionUpdate = (payload) => {
      emit('onORMCollectionUpdate', payload);
    };

    const filterField = (field) => {
      if (field.popover) {
        field.popover = undefined;
      }
      return field;
    };

    onMounted(() => {
      const Loader = ComponentLoader.getInstance();
      if(!vueInstance.proxy.$.components) {
        vueInstance.proxy.$.components = [];
      }
      _.merge(vueInstance.proxy.$.components, Loader.loadComponents([
        {
          pageName: urlRootPath,
          themeName: 'listCustomComponent',
          typeName: 'tableField',
        },
      ]));
    });

    return {
      onORMCollectionUpdate,
      filterField,
    };
  },
  mixins: [ListFieldUtil],
};

</script>

