<template>
  <div class="body-content-page">
    <PageNavigation
      :title="title"
      :subtitle="subtitle"
      :activeName="pageNavigation.activeName"
      :showFixedPageNavigation="pageNavigation.showFixedPageNavigation"
      :navItems="pageNavigation.navItems"
    />
    <div class="edit-content">
      <template v-for="(Form, key) in Forms" :key="key">
        <form class="edit-form" method="post" :action="Form.action">
<!--          <input type="hidden" name="_token" :value="csrf" />-->
          <template v-for="(field, key2) in Form.fields" :key="key2">
            <component :is="field.type" v-bind="field" />
          </template>
          <div
            v-if="Form.submits && Form.submits.length > 0"
            class="line-submit"
          >
            <div class="field">
              <input
                v-if="Form.ORM && Form.ORM.id"
                type="hidden"
                name="id"
                :value="Form.ORM.id"
              />
              <template v-for="(submit, key2) in Form.submits" :key="key2">
                <router-link
                  v-if="submit.linkTo"
                  :to="submit.linkTo"
                  :class="['btn', 'btn-link', 'btn-lg']"
                  :target="submit.targetBlank ? '_blank' : null"
                >
                  {{ submit.buttonText }}
                  <font-awesome-icon
                    v-if="submit.fontAwesomeIcon"
                    class="font-awesome-icon"
                    :icon="submit.fontAwesomeIcon"
                    size="sm"
                  />
                </router-link>
                <a
                  v-else-if="submit.href"
                  :class="['btn', 'btn-link', 'btn-lg']"
                  :href="submit.href ? submit.href : null"
                  :target="submit.targetBlank ? '_blank' : null"
                >
                  {{ submit.buttonText }}
                  <font-awesome-icon
                    v-if="submit.fontAwesomeIcon"
                    class="font-awesome-icon"
                    :icon="submit.fontAwesomeIcon"
                    size="sm"
                  />
                </a>
                <b-button
                  v-else
                  type="submit"
                  :variant="submit.variant ? submit.variant : 'primary'"
                  size="lg"
                  :name="submit.inputName ? submit.inputName : null"
                  :value="submit.value ? submit.value : null"
                  :ff-action="submit.action ? submit.action : null"
                  :ff-confirm="submit.confirm ? submit.confirm : null"
                  @click="onSubmitClick"
                >
                  {{ submit.buttonText }}
                  <font-awesome-icon
                    v-if="submit.fontAwesomeIcon"
                    class="font-awesome-icon"
                    :icon="submit.fontAwesomeIcon"
                    size="sm"
                  />
                </b-button>
              </template>
            </div>
          </div>
        </form>
      </template>
    </div>
  </div>
</template>

<script setup lang="ts">
import { getCurrentInstance, inject, onActivated, ref, watch } from 'vue';
import PageNavigation from '@fanswoo/control-center/layouts/page-navigation.vue';
import { ComponentLoader } from '@fanswoo/component-loader/main';
import _ from 'lodash';

const props = defineProps({
  title: {
    type: String,
    default: '',
  },
  subtitle: {
    type: String,
    default: '',
  },
  Forms: {
    type: Object,
    default: () => ({}),
  },
  showLeaveConfirm: {
    type: Boolean,
    default: false,
  },
  pageNavigation: {
    type: Object,
    default: () => ({}),
  },
  styleClass: {
    type: String,
    default: '',
  },
});

const csrf = ref('');
const showLeaveConfirmIsChange = ref(false);
const urlRootPath = inject('urlRootPath');

onActivated(() => {
  getCurrentInstance().emit('initPageData');
});

const pluck = (array, key) => {
  return array.map((item) => item[key]);
};

const onSubmitClick = () => {
  showLeaveConfirmIsChange.value = false;
  window.removeEventListener('beforeunload', onShowLeaveConfirm);
};

const onShowLeaveConfirm = () => {
  if (props.showLeaveConfirm && showLeaveConfirmIsChange.value) {
    return window.confirm('資料尚未儲存，確定要離開嗎？');
  }
  return true;
};

const onBeforeunload = () => {
  return true;
};

const onShowLeaveConfirmChange = () => {
  if (props.showLeaveConfirm) {
    showLeaveConfirmIsChange.value = true;
    window.addEventListener('beforeunload', onBeforeunload);
  }
};

const bindEvent = () => {
  document.querySelectorAll('input,textarea,select').forEach(element => {
    element.addEventListener('change', onShowLeaveConfirmChange);
  });
};

const unbindEvent = () => {
  document.querySelectorAll('input,textarea,select').forEach(element => {
    element.removeEventListener('change', onShowLeaveConfirmChange);
  });
  window.removeEventListener('beforeunload', onBeforeunload);
};

const Loader = ComponentLoader.getInstance();
const vueInstance = getCurrentInstance();
if(!vueInstance.proxy.$.components) {
  vueInstance.proxy.$.components = [];
}
_.merge(vueInstance.proxy.$.components, Loader.loadComponents([
  {
    pageName: urlRootPath.value,
    themeName: 'editCustomComponent',
    typeName: 'lineContent',
  },
  {
    pageName: urlRootPath.value,
    themeName: 'layout',
    typeName: 'layout',
  },
]));

csrf.value = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
bindEvent();

watch(() => props.showLeaveConfirm, (newValue, oldValue) => {
  if (newValue !== oldValue) {
    onShowLeaveConfirmChange();
  }
});
</script>

