<template>
    <span>
        {{ beforeText }}
        <select
          :name="inputName"
          :class="className"
          :disabled="dataDisabled"
          @change="[
                changeCssStyle($event),
                onORMCollectionUpdate($event)
            ]"
          :style="cssStyle"
        >
            <template v-for="(option, optionKey) in dataOptions" :key="optionKey">
                <option
                  :value="option.value"
                  :selected="value == option.value"
                  :disabled="option.disabled ? true : false"
                  :style="option.style"
                >
                {{ option.text }}
                </option>
            </template>
        </select>
    </span>
</template>

<script setup lang="ts">

import { computed, onMounted, ref, watch } from "vue";

const props = defineProps({
  value: {
    type: Number,
    default: 0,
  },
  inputName: {
    type: String,
    default: '',
  },
  ORMAttrFieldSettingName: {
    type: String,
    default: '',
  },
  disabled: {
    type: Boolean,
    default: false,
  },
  className: {
    type: String,
    default: '',
  },
  inputOptions: {
    type: Array,
    default: () => [],
  },
  beforeText: {
    type: String,
    default: '',
  },
  ORM: {
    type: Object,
    default: () => ({}),
  },
});

const emit = defineEmits(['onORMCollectionUpdate']);
const cssStyle = ref({});
const dataOptions = ref(props.inputOptions);

const dataDisabled = computed(() => {
  if (props.ORMAttrFieldSettingName && props.ORM[props.ORMAttrFieldSettingName]) {
    return props.ORM[props.ORMAttrFieldSettingName].disabled;
  }
  return props.disabled;
});

const resetCssStyle = () => {
  let optionAttr = {};

  for (let option of dataOptions.value) {
    if (option.value === props.value) {
      optionAttr = option;
    }
  }

  cssStyle.value.color = optionAttr.color;

  if (optionAttr.borderColor) {
    cssStyle.value.borderStyle = 'solid';
  } else {
    cssStyle.value.borderStyle = '';
  }

  cssStyle.value.borderColor = optionAttr.borderColor;
  cssStyle.value = {
    ...cssStyle.value
  };
};

const changeCssStyle = (event) => {
  let optionAttr = dataOptions.value[event.target.selectedIndex];

  cssStyle.value.color = optionAttr.color;

  if (optionAttr.borderColor) {
    cssStyle.value.borderStyle = 'solid';
  } else {
    cssStyle.value.borderStyle = '';
  }

  cssStyle.value.borderColor = optionAttr.borderColor;
};

const onORMCollectionUpdate = (event) => {
  emit('onORMCollectionUpdate', {
    target: event.currentTarget
  });
};

onMounted(() => {
  resetCssStyle();
});

watch(() => props.value, () => {
  resetCssStyle();
});
</script>