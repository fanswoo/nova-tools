<template>
  <div>
    <component
      :is="pageData.pageComponentType"
      v-if="
        pageData &&
        typeof pageData == 'object' &&
        Object.keys(pageData).length > 0
      "
      ref="customComponent"
      v-bind="pageData"
      @initPageData="initPageData"
    />
    <RouteModalSwitch
      v-if="$route.query.modal && isWatchingPath"
      :modalType="$route.query.modal"
    />
  </div>
</template>

<script setup lang="ts">
import { Popover } from 'bootstrap';
import { onMounted, shallowRef, watch, computed, ref, inject, getCurrentInstance } from 'vue';
import { Message } from '@fanswoo/message/main';
import { ComponentLoader } from '@fanswoo/component-loader/main';
import RouteModalSwitch from '@fanswoo/control-center/core/route-modal-switch.vue';
import { useStore } from '@/control-center/store/control-center-store';
import _ from 'lodash';

interface messageShow {
  url: string;
  rootUrl: string;
  fails: boolean;
}

interface pageData {
  messageShow?: messageShow;
  title?: string;
  subtitle?: string;
  isRoutePageDestroy?: boolean;
}

const pageDataDefault = {
  pageComponentType: null,
  messageShow: {
    url: '',
    rootUrl: '',
    fails: false,
  },
  title: '',
  subtitle: '',
  isRoutePageDestroy: false,
};

const props = defineProps({
  routePagePath: {
    type: String,
    default: '',
  },
});
const store = useStore();
const customComponent = ref(null);
const vueInstance = getCurrentInstance();
const pageData = ref(pageDataDefault);
const isRoutePageDestroy = ref();
const adminSidebox = inject('adminSidebox');
const urlRootPath = inject('urlRootPath');
const onResetPageData = computed(() => store.state.RoutePage.onResetPageData);
const router = computed(() => vueInstance.proxy.$router);

const setPageData = (state) => {
  store.commit('RoutePage/setPageData', state);
}

const emit = defineEmits(['onBeforeRouteDestroy']);

const onBeforeRouteUpdate = (to, from) => {
  if (isRoutePageDestroy.value) {
    if (customComponent.value) {
      const continueNext = customComponent.value.onBeforeRouteDestroy();

      if (continueNext === false) {
        return false;
      }

      return true;
    }

    emit('onBeforeRouteDestroy', true);

    return true;
  }

  if (customComponent.value) {
    const continueNext = customComponent.value.onBeforeRouteUpdate(to, from);

    if (continueNext === false) {
      return false;
    }

    return true;
  }
  return false;
};

const childName = computed(() => {
  let childNameCache;
  if (
    vueInstance.proxy.$route.params?.childName1 &&
    vueInstance.proxy.$route.params?.childName2 &&
    vueInstance.proxy.$route.params?.childName3 &&
    vueInstance.proxy.$route.params?.childName4
  ) {
    childNameCache = {
      childName1: vueInstance.proxy.$route.params.childName1,
      childName2: vueInstance.proxy.$route.params.childName2,
      childName3: vueInstance.proxy.$route.params.childName3,
      childName4: vueInstance.proxy.$route.params.childName4,
    };
  }

  return childNameCache;
});

const getPageDataResponse = async(pageDataLink) => {
  let response;
  try {
    response = await axios.get(pageDataLink, {
      params: vueInstance.proxy.$route.query,
    });
  } catch (error) {
    console.warn(error);
  }

  return response;
}

const getPageTitleChildTitle = () => {
  if (
    childName.value &&
    adminSidebox[childName.value.childName1] &&
    adminSidebox[childName.value.childName1].child &&
    adminSidebox[childName.value.childName1].child[
      childName.value.childName2
      ] &&
    adminSidebox[childName.value.childName1].child[
      childName.value.childName2
      ].child &&
    adminSidebox[childName.value.childName1].child[
      childName.value.childName2
      ].child[childName.value.childName3] &&
    adminSidebox[childName.value.childName1].child[
      childName.value.childName2
      ].child[childName.value.childName3].controller &&
    adminSidebox[childName.value.childName1].child[
      childName.value.childName2
      ].child[childName.value.childName3].controller[childName.value.childName4]
  ) {
    return {
      title:
      adminSidebox[childName.value.childName1].child[
        childName.value.childName2
        ].title,
      subtitle:
      adminSidebox[childName.value.childName1].child[
        childName.value.childName2
        ].child[childName.value.childName3].controller[
        childName.value.childName4
        ].title,
    };
  }

  return {
    title: '',
    subtitle: '',
  };
}

const initPageData = async() => {
  let pageDataLink;
  if (
    vueInstance.proxy.$route.meta?.pageData &&
    vueInstance.proxy.$route.meta?.pageData instanceof Function
  ) {
    pageDataLink = vueInstance.proxy.$route.meta?.pageData(vueInstance.proxy.$route);
  } else if (vueInstance.proxy.$route.meta?.pageData) {
    pageDataLink = vueInstance.proxy.$route.meta?.pageData;
  } else {
    pageDataLink = `${urlRootPath.value}/${childName.value.childName1}/${childName.value.childName2}/${childName.value.childName3}/${childName.value.childName4}/pageData`;
  }

  pageData.value = pageDataDefault;

  const response = await getPageDataResponse(pageDataLink);

  pageData.value = response.data;

  if (typeof pageData.value === 'string') {
    console.error(pageData.value);
    return false;
  }

  if (pageData.value.messageShow) {
    const url = pageData.value.messageShow?.url;
    pageData.value.messageShow.url = pageData.value.messageShow.rootUrl;

    const message = Message.getInstance();
    message.show(pageData.value.messageShow);

    if (url) {
      vueInstance.proxy.$router.push(url);
    }

    if (pageData.value.messageShow.fails) {
      pageData.value = pageDataDefault;
      return false;
    }
  }

  if (!pageData.value?.title) {
    pageData.value.title = getPageTitleChildTitle().title;
  }

  if (!pageData.value?.subtitle) {
    pageData.value.subtitle = getPageTitleChildTitle().subtitle;
  }

  isRoutePageDestroy.value = pageData.value.isRoutePageDestroy;

  setTimeout(() => {
    const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    const popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
      return new Popover(popoverTriggerEl)
    });
  }, 3000);

  return true;
}

watch(() => onResetPageData, (newValue) => {
  if (newValue) {
    initPageData()
  }
  setPageData(false)

  if (onResetPageData.value === true) {
    initPageData();
  }
  setPageData(false);
});

watch(router, (to, from) => {
  if (
    Object.keys(from.query).includes('sidebarOpened') ||
    Object.keys(to.query).includes('sidebarOpened') ||
    Object.keys(from.query).includes('searchBoxDisplay') ||
    Object.keys(to.query).includes('searchBoxDisplay') ||
    Object.keys(from.query).includes('modal') ||
    Object.keys(to.query).includes('modal')
  ) {
    return;
  }

  if (to.path === from.path && !_.isEqual(to.query, from.query)) {
    initPageData();
  }
});

const isWatchingPath = computed(() => {
  return props.routePagePath === vueInstance.proxy.$route.fullPath;
});

const loader = ComponentLoader.getInstance();
if(!vueInstance.proxy.$.components) {
  vueInstance.proxy.$.components = [];
}
_.merge(vueInstance.proxy.$.components, loader.loadComponents([
  {
    pageName: urlRootPath.value,
    themeName: 'routePage',
    typeName: 'routePage',
  },
]));

onMounted(() => {
  store.commit('RoutePage/resetCacheComponents');
  initPageData();
});

defineExpose({
  onBeforeRouteUpdate
});
</script>
