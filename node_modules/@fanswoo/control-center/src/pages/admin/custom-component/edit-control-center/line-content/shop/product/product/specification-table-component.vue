<template>
  <div>
    <div
      v-if="shouldDisplaySpecificationNames || shouldDisplaySpecificationColors"
      class="line-content"
    >
      <div class="title">價格</div>
      <div class="field" style="max-width: 768px; overflow: scroll">
        <b-table
          ref="table"
          striped
          hover
          :items="specifications"
          :fields="specificationFields"
        >
          <template #cell(colorName)="data">
            <p style="min-width: 150px">{{ data.item.colorName }}</p>
            <input
              type="hidden"
              name="specificationColorNames[]"
              :value="data.item.colorName"
            />
          </template>
          <template #cell(name)="data">
            <p style="min-width: 150px">{{ data.item.name }}</p>
            <input
              type="hidden"
              name="specificationNames[]"
              :value="data.item.name"
            />
          </template>
          <template #cell(cost)="data">
            <b-form-input
              :value="data.item.cost"
              style="width: 100px"
              type="number"
              name="specificationCosts[]"
            />
          </template>
          <template #cell(price)="data">
            <b-form-input
              :value="data.item.price"
              style="width: 100px"
              type="number"
              name="specificationPrices[]"
            />
          </template>
          <template #cell(itemCode)="data">
            <b-form-input
              :value="data.item.itemCode"
              style="width: 100px"
              type="number"
              name="specificationItemCodes[]"
            />
          </template>
          <template #cell(stocknum)="data">
            <b-form-input
              :value="data.item.stocknum"
              style="width: 100px"
              type="number"
              name="specificationStocknums[]"
            />
            <input
              type="hidden"
              name="specificationColorRgbs[]"
              :value="data.item.colorRgb"
            />
            <input
              type="hidden"
              name="specificationIds[]"
              :value="data.item.id"
            />
          </template>
        </b-table>
      </div>
    </div>
    <template v-else>
      <div class="line-content">
        <div class="title">成本</div>
        <div class="field">
          <input
            v-if="specifications[0]"
            v-model.number="specifications[0].cost"
            type="number"
            name="specificationCosts[]"
            placeholder="成本"
          />
          <div class="explanation">請填寫成本</div>
        </div>
      </div>
      <div class="line-content">
        <div class="title">價格</div>
        <div class="field">
          <input
            v-if="specifications[0]"
            v-model.number="specifications[0].price"
            type="number"
            name="specificationPrices[]"
            placeholder="價格"
          />
          <div class="explanation">請填寫價格</div>
        </div>
      </div>
      <div class="line-content">
        <div class="title">庫存數量</div>
        <div class="field">
          <input
            v-if="specifications[0]"
            v-model.number="specifications[0].stocknum"
            type="number"
            name="specificationStocknums[]"
            placeholder="庫存"
          />
          <input
            v-if="specifications[0]"
            v-model="specifications[0].id"
            type="hidden"
            name="specificationIds[]"
          />
          <div class="explanation">請填寫庫存數量</div>
        </div>
      </div>
    </template>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onUpdated } from 'vue';
import { useStore } from '@/control-center/store/control-center-store';

// Props
const props = defineProps({
  specifications: {
    type: Array,
    default: () => [],
  },
  hasErp: {
    type: Boolean,
    default: false,
  }
});

// Refs
const table = ref<null | HTMLFormElement>(null);

// Vuex store
const store = useStore();
const specificationNames = computed(() => store.getters['ProductSpecification/noEmptySpecificationNames']);
const specificationColors = computed(() => store.getters['ProductSpecification/noEmptySpecificationColors']);
const specifications = computed(() => store.state.ProductSpecification.specifications);

// Computed properties
const shouldDisplaySpecificationNames = computed(() => specificationNames.value.length > 0);
const shouldDisplaySpecificationColors = computed(() => specificationColors.value.length > 0);

const specificationFields = computed(() => {
  const fields = [];

  if (shouldDisplaySpecificationColors.value) {
    fields.push({ key: 'colorName', label: '型別' });
  }

  if (shouldDisplaySpecificationNames.value) {
    fields.push({ key: 'name', label: '規格' });
  }

  fields.push({ key: 'cost', label: '成本' }, { key: 'price', label: '價格' });

  if (props.hasErp) {
    fields.push({ key: 'itemCode', label: '貨品型號' });
  }

  fields.push({ key: 'stocknum', label: '庫存數量' });

  return fields;
});

// Lifecycle hooks
onUpdated(() => {
  if (table.value) {
    // Assuming `refresh` is a method you want to call on your table element.
    // You might need to adjust this part depending on how you're interacting with the table in Vue 3.
    table.value.refresh();
  }
});
</script>

