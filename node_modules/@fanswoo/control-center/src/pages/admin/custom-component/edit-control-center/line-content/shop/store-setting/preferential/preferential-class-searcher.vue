<template>
  <div>
    <LineTitle
      title="選取分類"
      text="請填寫使用者達成條件後可獲得之優惠"
    ></LineTitle>
    <div class="line-content class-display" linecontent="classDisplay">
      <div class="title">分類</div>
      <div class="field">
        <ul id="root">
          <category-list
            v-for="category in categories"
            :key="category.id"
            :category="category"
            :order="0"
            :uncheckable="true"
            :locked="$parent.locked"
          />
        </ul>
        <input
          type="hidden"
          name="categoryIds[]"
          :key="categoryId"
          :value="categoryId"
          v-for="categoryId in this.categoryIds"
        />
      </div>
    </div>
    <div
      class="line-content select-item"
      linecontent="selectItem"
      v-if="categoryIds.length > 0"
    >
      <div class="title">選取排除產品</div>
      <div class="field">
        <button class="btn" @click="showModalAndSearchExcludedItem($bvModal)">
          選取排除產品
        </button>
      </div>
    </div>
    <div class="line-content select-item" linecontent="selectItem">
      <div class="title">已排除產品 ({{ selectedItems.length }})</div>
      <div class="fill-field scrollable">
        <table class="table" style="min-width: 768px">
          <thead>
            <tr class="d-flex">
              <th class="col-1" :style="widthStyle(1.5)">
                <div class="d-flex align-items-center">
                  <input
                    type="checkbox"
                    v-model="checkAllSelectedItems"
                    id="check-all-selected-items"
                  />
                  <label class="m-0 ml-1" for="check-all-selected-items"
                    >全選</label
                  >
                </div>
              </th>
              <th class="col-2" :style="widthStyle(2)">圖片</th>
              <th class="col-3" :style="widthStyle(4)">產品名稱</th>
              <th class="col-1" :style="widthStyle(4)">價格區間</th>
              <th class="col-1" :style="widthStyle(3)" v-if="!$parent.locked">
                <a
                  v-show="hasItemsToDeleted"
                  href=""
                  @click.prevent="deleteCheckedSelectedItems"
                  >刪除已選擇商品</a
                >
              </th>
            </tr>
          </thead>
          <tbody>
            <tr
              class="d-flex"
              v-for="selectedItem in selectedItems"
              :key="selectedItem.id"
            >
              <td class="col-1" :style="widthStyle(1.5)">
                <input
                  class="d-block h-100"
                  type="checkbox"
                  name="checks[]"
                  v-model="selectedItem.checkedForDelete"
                />
                <input
                  type="hidden"
                  name="excludedItemIds[]"
                  :value="selectedItem.id"
                  v-if="selectedItem.inCurrentSelectedCategories"
                />
                <input
                  type="hidden"
                  name="excludedItemTypes[]"
                  :value="itemClass"
                />
              </td>
              <td
                class="col-2"
                :style="widthStyle(2)"
                :class="{
                  'opacity-50': !selectedItem.inCurrentSelectedCategories,
                }"
              >
                <img
                  :src="selectedItem.imgSrc"
                  :alt="selectedItem.name"
                  style="width: 100%"
                />
              </td>
              <td
                class="col-3"
                :style="widthStyle(4)"
                :class="{
                  'opacity-50': !selectedItem.inCurrentSelectedCategories,
                }"
              >
                {{ selectedItem.name }}
              </td>
              <td
                class="col-2"
                :style="widthStyle(4)"
                :class="{
                  'opacity-50': !selectedItem.inCurrentSelectedCategories,
                }"
              >
                $ {{ selectedItem.minPrice }} - $
                {{ selectedItem.maxPrice }}
              </td>
              <td class="col-1" :style="widthStyle(3)" v-if="!$parent.locked">
                <a
                  href=""
                  @click.prevent="deleteSelectedItem(selectedItem)"
                  style="color: red"
                  >刪除</a
                >
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div>
      <b-modal
        title="選取產品"
        centered
        id="modal-class"
        size="lg"
        no-close-on-esc
        no-close-on-backdrop
        :header-class="['flex-column', 'align-items-stretch']"
      >
        <template v-slot:modal-header="{ close }">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="m-0">選取產品</h5>
            <div class="d-flex justify-content-center align-items-center">
              <input
                type="checkbox"
                v-model="selectItemsInThisPage"
                id="select-items-in-this-page"
              />
              <label class="m-0 ml-1" for="select-items-in-this-page"
                >選擇此頁所有產品</label
              >
            </div>
          </div>
          <div
            class="
              input-group
              d-flex
              justify-content-center
              align-items-center
              mb-3
            "
          >
            <div class="input-group-prepend">
              <select
                class="custom-select"
                name="itemSearchType"
                v-model="itemSearchTypeData"
              >
                <option
                  v-for="option in itemSearchTypeOptions"
                  :value="option.value"
                  :key="option.id"
                >
                  {{ option.text }}
                </option>
              </select>
            </div>
            <input
              type="text"
              class="form-control"
              placeholder="請輸入搜尋字詞"
              v-model="searchKeyword"
            />
            <div class="input-group-append">
              <button
                class="btn btn-outline-secondary"
                type="button"
                @click="searchExcludedItem"
              >
                <font-awesome-icon icon="search" />
              </button>
            </div>
          </div>
        </template>
        <template v-slot:default="{ hide }">
          <div v-if="searchingItems" class="text-center">
            <b-spinner label="Loading..."></b-spinner>
          </div>
          <template v-else>
            <div
              class="container-fluid content-row"
              v-if="searchItems.length > 0"
            >
              <div class="row">
                <div
                  class="col-12 col-sm-4 mb-3"
                  :key="index"
                  v-for="(item, index) in searchItems"
                  :current-page="currentPage"
                  :per-page="0"
                >
                  <div class="card h-100">
                    <div class="card h-100">
                      <img
                        :src="item.imgSrc"
                        class="card-img-top"
                        :alt="item.name"
                        style="height: auto"
                      />
                      <div class="card-body p-3">
                        <h6
                          class="card-title"
                          style="height: calc(12px * 3 * 1.2); overflow: hidden"
                        >
                          {{ item.name }}
                        </h6>
                        <div
                          class="
                            d-flex
                            justify-content-center
                            align-items-center
                          "
                        >
                          <input
                            type="checkbox"
                            v-model="item.selected"
                            @change="syncTempSelectedItems(item)"
                            :id="`select-this-item${index}`"
                          />
                          <label
                            class="m-0 ml-1"
                            :for="`select-this-item${index}`"
                            >選擇</label
                          >
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <b-row class="justify-content-center">
                <b-col md="6" class="my-1">
                  <b-pagination
                    class="justify-content-center"
                    :total-rows="totalItemsCount"
                    v-model="currentPage"
                    :per-page="perPage"
                    @input="searchExcludedItem"
                  >
                  </b-pagination>
                </b-col>
              </b-row>
            </div>
            <div v-else class="text-center">
              <h4>查無結果</h4>
            </div>
          </template>
        </template>
        <template v-slot:modal-footer="{ ok, cancel }">
          <b-button
            size="sm"
            variant="primary"
            @click="
              ok();
              confirmSelectItems();
              searchKeyword = '';
            "
          >
            確定
          </b-button>
          <b-button
            size="sm"
            variant="secondary"
            @click="
              cancel();
              searchKeyword = '';
            "
          >
            取消
          </b-button>
        </template>
      </b-modal>
    </div>
  </div>
</template>

<script>
import EventBus from '@fanswoo/core/bootstrap/event-bus';
import LineTitle from '@fanswoo/control-center/custom-component/edit-control-center/line-content/base/line-title.vue';
import CategoryList from '@fanswoo/control-center/pages/admin/custom-component/edit-control-center/line-content/shop/store-setting/preferential/category-list.vue';

const ItemSearchType = {
  NAME: 'name',
  TAG: 'tag',
  CLASS: 'class',
};

export default {
  components: {
    LineTitle,
    CategoryList,
  },
  props: {
    itemClass: {
      type: String,
      default: 'product',
    },
    categories: {
      type: Array,
      required: true,
    },
    currentSelectedItems: {
      type: Array,
      required: true,
    },
  },
  data: () => {
    return {
      ItemSearchType: {
        NAME: 'name',
        TAG: 'tag',
        CLASS: 'class',
      },
      itemSearchTypeData: ItemSearchType.NAME,

      searchKeyword: '',

      currentPage: 1,
      perPage: 6,
      searchItems: [],
      searchingItems: false,
      totalItemsCount: 0,

      tempSelectedItems: [],
      selectedItems: [],
      checkAllSelectedItems: false,
      selectItemsInThisPage: false,
      pageChanged: true,
    };
  },
  watch: {
    selectItemsInThisPage(value) {
      this.searchItems.forEach((item) => {
        item.selected = value;

        if (value) {
          this.pushToTempSelectedItems(item);
        } else {
          if (!this.pageChanged) {
            this.deleteFromTempSelectedItems(item);
          }
        }
      });

      this.pageChanged = false;
    },
    currentPage(value, oldValue) {
      this.pageChanged = true;
    },
    checkAllSelectedItems(value) {
      this.selectedItems.forEach((item) => {
        item.checkedForDelete = value;
      });
    },
    categoryIds(value) {
      for (let selectedItem of this.selectedItems) {
        selectedItem.inCurrentSelectedCategories =
          selectedItem.categoryIds.some((id) => {
            return this.categoryIds.indexOf(id) !== -1;
          });
      }
    },
  },
  computed: {
    categoryIds() {
      return this.getCategoryIds(this.categories);
    },
    itemSearchTypeOptions() {
      return [
        {
          id: 1,
          value: this.ItemSearchType.NAME,
          text: '透過名稱搜尋',
        },
        // {
        //   id: 2,
        //   value: this.ItemSearchType.TAG,
        //   text: "透過標籤搜尋"
        // },
        // {
        //   id: 3,
        //   value: this.ItemSearchType.CLASS,
        //   text: "透過分類搜尋"
        // }
      ];
    },
    tempSelectedItemIds() {
      return this.pluck('id', this.tempSelectedItems);
    },
    hasItemsToDeleted() {
      return this.selectedItems.some((item) => {
        return item.checkedForDelete;
      });
    },
  },
  methods: {
    getCategoryIds(categories) {
      let categoryIds = [];

      for (let category of categories) {
        if (category.children) {
          categoryIds = categoryIds.concat(
            this.getCategoryIds(category.children),
          );
        } else {
          if (category.checked) {
            categoryIds = categoryIds.concat([category.id]);
          }
        }
      }

      return categoryIds;
    },
    syncTempSelectedItems(item) {
      if (item.selected) {
        this.pushToTempSelectedItems(item);
      } else {
        this.deleteFromTempSelectedItems(item);
      }
    },
    pushToTempSelectedItems(item) {
      let tempSelectedItemIndex = this.tempSelectedItems.findIndex(
        (tempSelectedItem) => {
          return tempSelectedItem.id == item.id;
        },
      );

      if (tempSelectedItemIndex === -1) {
        this.tempSelectedItems.push(item);
      }
    },
    deleteFromTempSelectedItems(item) {
      let tempSelectedItemIndex = this.tempSelectedItems.findIndex(
        (tempSelectedItem) => {
          return tempSelectedItem.id == item.id;
        },
      );

      if (tempSelectedItemIndex !== -1) {
        this.tempSelectedItems.splice(tempSelectedItemIndex, 1);
      }
    },
    showModalAndSearchExcludedItem(bvModal) {
      if (this.$parent.locked) return false;
      bvModal.show('modal-class');

      this.currentPage = 1;
      this.searchExcludedItem();
    },
    async searchExcludedItem() {
      this.searchingItems = true;

      axios
        .get(
          `item/${this.itemSearchTypeData}/${this.itemClass}?keyword=${
            this.searchKeyword
          }&offset=${(this.currentPage - 1) * this.perPage}&limit=${
            this.perPage
          }&categoryIds=${this.categoryIds}`,
        )
        .then((res) => {
          this.searchItems = res.data.items;

          let sameCount = 0;
          for (let searchItem of this.searchItems) {
            if (this.tempSelectedItemIds.indexOf(searchItem.id) !== -1) {
              searchItem.selected = true;
              sameCount++;
            }
          }
          if (sameCount == this.searchItems.length) {
            this.selectItemsInThisPage = true;
          } else {
            this.selectItemsInThisPage = false;
          }
          this.totalItemsCount = res.data.totalCount;
          this.searchingItems = false;
        })
        .catch((err) => {
          this.searchingItems = false;
        });
    },
    confirmSelectItems() {
      this.selectedItems = JSON.parse(JSON.stringify(this.tempSelectedItems));
    },
    deleteSelectedItem(item) {
      let selectedItemIndex = this.selectedItems.findIndex((selectedItem) => {
        return selectedItem.id == item.id;
      });

      this.selectedItems.splice(selectedItemIndex, 1);

      let tempSelectedItemIndex = this.tempSelectedItems.findIndex(
        (tempSelectedItem) => {
          return tempSelectedItem.id == item.id;
        },
      );

      this.tempSelectedItems.splice(tempSelectedItemIndex, 1);

      if (this.selectedItems.length == 0) {
        this.checkAllSelectedItems = false;
      }
    },
    deleteCheckedSelectedItems() {
      this.selectedItems = this.selectedItems.filter((item) => {
        return !item.checkedForDelete;
      });

      this.checkAllSelectedItems = false;

      this.tempSelectedItems = JSON.parse(JSON.stringify(this.selectedItems));
    },
    widthStyle(n) {
      let width = 50 * n;
      return {
        minWidth: `${width}px`,
        maxWidth: `${width}px`,
      };
    },
    pluck(column, array) {
      return array.map((item) => {
        return item[column];
      });
    },
  },
  mounted() {
    this.selectedItems = this.currentSelectedItems || this.selectedItems;
  },
  updated() {},
  beforeDestroy() {
    EventBus.$off();
  },
};
</script>

<style scoped lang="scss">
.opacity-50 {
  opacity: 0.5;
}

.input-group-append {
  height: 30px;
}

.class-display ul {
  padding: 0;
  list-style: none;
  border: 1px solid #ccc;
}

.custom-select {
  height: 30px;
  margin: 0;
}

// .edit-content .line-content .field select {
//   height: 30px;
//   margin: 0;
// }

.btn {
  border: 1px solid #ccc;
}

.item-search-type .input-group {
  width: 100%;
  @media (min-width: 768px) {
    width: 50%;
  }
}

[id$='BV_modal_outer_'] {
  z-index: 9999 !important;
}

// #modal-class___BV_modal_outer_ {
//   z-index: 9999 !important;
// }

.scrollable {
  overflow-x: scroll;
}

.table th,
.table td {
  border-top: 0;
  border-bottom: 1px solid #dee2e6;
  padding-left: 1.25rem;
}

input[type='text'],
input[type='number'],
input[type='password'] {
  height: auto;
}
</style>
