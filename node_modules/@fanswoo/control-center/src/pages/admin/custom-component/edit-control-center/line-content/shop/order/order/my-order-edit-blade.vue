<template>
  <div class="line-content">
    <table class="table table-hover">
      <thead>
        <tr class="table-secondary">
          <th scope="col">品名</th>
          <th scope="col">型別</th>
          <th scope="col">規格</th>
          <th scope="col">數量</th>
          <th scope="col">單價</th>
          <th scope="col">單品合計</th>
          <th v-if="hasErp" scope="col">倉別</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(Cart, index) in order.items" :key="Cart.id">
          <td class="">
            <span v-if="Cart.Product && Cart.Product.name">
              {{ Cart.Product.name }}
            </span>
            <b v-if="Cart.isPreOrder == 1" style="color: red"> (預購品) </b>
          </td>
          <td class="">
            <span v-if="Cart.Specification && Cart.Specification.colorName">
              {{ Cart.Specification.colorName }}
            </span>
            <span v-else> 無 </span>
          </td>
          <td class="">
            <span v-if="Cart.Specification && Cart.Specification.name">
              {{ Cart.Specification.name }}
            </span>
            <span v-else> 無 </span>
          </td>
          <td class="">
            {{ Cart.amount }}
          </td>
          <td class="">
            <span v-if="Cart.Specification && Cart.Specification.price">
              {{ Cart.Specification.price }}
            </span>
          </td>
          <td class="">
            {{ Cart.priceTotal }}
          </td>
          <td v-if="hasErp" class="">
            <input
              type="hidden"
              name="itemCodes[]"
              :value="Cart.Specification.itemCode"
            />
            <select
              v-if="
                Cart.Specification.warehouseOptions &&
                Cart.Specification.warehouseOptions.length > 0
              "
              name="warehouseIds[]"
              @change="
                changeCartSpecificationChildren($event.target.value, index)
              "
            >
              <option
                v-for="warehouse in Cart.Specification.warehouseOptions"
                :key="warehouse.id"
                :value="warehouse.id"
              >
                {{ warehouse.name }}
              </option>
            </select>
            <select
              v-if="
                Cart.Specification.warehouseOptions &&
                Cart.Specification.childrenShelfOptions.length > 0
              "
              name="shelfIds[]"
              @change="
                changeCartSpecificationShelfInventory(
                  $event.target.value,
                  index,
                )
              "
            >
              <option :value="null">依照倉庫別，不指定貨架</option>
              <option
                v-for="shelf in Cart.Specification.childrenShelfOptions"
                :key="shelf.id"
                :value="shelf.id"
              >
                {{ shelf.name }}
              </option>
            </select>
            <!-- <br> -->
            <br />
            <span v-if="Cart.Specification.initialInventoryByWarehouse != null"
              >目前總庫存：{{
                Cart.Specification.initialInventoryByWarehouse
              }}</span
            >
            <br />
            <span v-if="Cart.Specification.initialInventoryByShelf != null"
              >目前貨架庫存：{{
                Cart.Specification.initialInventoryByShelf
              }}</span
            >
          </td>
        </tr>
      </tbody>
    </table>
    <table class="table table-hover">
      <thead class="thead-light">
        <tr class="table-secondary">
          <th scope="col">原價</th>
          <th scope="col">運費</th>
          <th scope="col">折扣</th>
          <th scope="col">使用購物金</th>
          <th scope="col">總計</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="">
            {{ order.payCartPriceTotal }}
          </td>
          <td class="">
            {{ order.payPriceFreight }}
          </td>
          <td class="">
            {{ order.tradeinCount }}
          </td>
          <td class="">
            {{ order.couponCount }}
          </td>
          <td class="">
            {{ order.payPriceTotal }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</template>
<script>
export default {
  props: ['order', 'HasErp', 'purchaseSuccess'],
  computed: {
    hasErp() {
      return this.HasErp;
    },
  },
  mounted() {
    for (let i = 0; i < this.order.items.length; i += 1) {
      if (this.order.items[i].Specification.warehouseOptions) {
        this.changeCartSpecificationChildren(
          this.order.items[i].Specification.warehouseOptions[0].id,
          i,
        );
      }
    }
  },
  methods: {
    changeCartSpecificationChildren(warehouseId, CartIndex) {
      this.order.items[CartIndex].Specification.childrenShelfOptions =
        this.order.items[CartIndex].Specification.warehouseOptions.find(
          (warehouseOption) => warehouseOption.id === warehouseId,
        ).children; // 修改貨架子項目

      this.changeCartSpecificationWarehouseInventory(warehouseId, CartIndex);

      const shelfId = null;
      this.changeCartSpecificationShelfInventory(shelfId, CartIndex);
    },
    changeCartSpecificationWarehouseInventory(warehouseId, CartIndex) {
      this.order.items[
        CartIndex
      ].Specification.initialInventoryByWarehouse = this.order.items[
        CartIndex
      ].Specification.warehouseOptions.find(
        (warehouseOption) => warehouseOption.id === warehouseId,
      ).inventory;
    },
    changeCartSpecificationShelfInventory(shelfId, CartIndex) {
      if (shelfId) {
        this.order.items[CartIndex].Specification.initialInventoryByShelf =
          this.order.items[
            CartIndex
          ].Specification.childrenShelfOptions.find(
            (childrenShelfOption) => childrenShelfOption.id === shelfId,
          ).inventory;
      } else {
        this.order.items[CartIndex].Specification.initialInventoryByShelf =
          null;
      }
    },
  },
};
</script>
