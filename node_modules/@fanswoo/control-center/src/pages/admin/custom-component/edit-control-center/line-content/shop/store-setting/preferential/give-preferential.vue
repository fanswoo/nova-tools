<template>
  <div>
    <div class="line-content" linecontent="giveType">
      <div class="title">優惠類型</div>
      <div class="field">
        <select
          v-if="requestId"
          disabled="true"
          name="giveType"
          v-model="giveTypeData"
        >
          <option value="coupon" v-if="hasUserCoupon">贈送點數</option>
          <option value="money">贈送現金折價</option>
          <option value="discount">贈送現金折扣</option>
          <option value="freight">運費折扣</option>
          <option value="gift" v-if="hasUserGift">贈送贈品</option>
        </select>
        <select v-else name="giveType" v-model="giveTypeData">
          <option value="coupon" v-if="hasUserCoupon">贈送點數</option>
          <option value="money">贈送現金折價</option>
          <option value="discount">贈送現金折扣</option>
          <option value="freight">運費優惠</option>
          <option value="gift" v-if="hasUserGift">贈送贈品</option>
        </select>
      </div>
    </div>
    <div class="line-content" linecontent="giveContent">
      <div class="title">優惠內容</div>
      <div class="field">
        <template v-if="giveTypeData == 'coupon'">
          贈送
          <input
            v-if="requestId"
            disabled="true"
            type="number"
            name="giveCoupon"
            v-model.number="giveCouponData"
            placeholder="10"
            style="width: 80px"
          />
          <input
            v-else
            type="number"
            name="giveCoupon"
            v-model.number="giveCouponData"
            placeholder="10"
            style="width: 80px"
          />
          點紅利點數
        </template>
        <template v-else-if="giveTypeData == 'money'">
          享有
          <input
            v-if="requestId"
            disabled="true"
            type="number"
            name="giveMoney"
            v-model.number="giveMoneyData"
            v-on:change="checkGiveMoney"
            placeholder="10"
            style="width: 80px"
          />
          <input
            v-else
            type="number"
            name="giveMoney"
            v-model.number="giveMoneyData"
            v-on:change="checkGiveMoney"
            placeholder="10"
            style="width: 80px"
          />
          元優惠
          <div class="explanation">
            請輸入折扣價格，但不能輸入小於啟用滿額優惠規則的價格(例如：不能輸入滿1000折1100元的情況)
          </div>
        </template>
        <template v-else-if="giveTypeData == 'discount'">
          享有
          <input
            v-if="requestId"
            disabled="true"
            min="10"
            max="99"
            type="number"
            name="giveDiscount"
            v-model.number="giveDiscountData"
            v-on:change="checkGiveDiscount"
            placeholder="10"
            style="width: 80px"
          />
          <input
            v-else
            min="10"
            max="99"
            type="number"
            name="giveDiscount"
            v-model.number="giveDiscountData"
            v-on:change="checkGiveDiscount"
            placeholder="10"
            style="width: 80px"
          />
          折優惠
          <div class="explanation">
            請輸入折扣 % 數，如果輸入 95 表示打 95 折、輸入 80 表示打 8 折。最低
            1 折最高 99 折
          </div>
        </template>
        <template v-else-if="giveTypeData == 'freight'">
          此筆訂單享有
          <input
            v-if="requestId"
            disabled="true"
            min="0"
            type="number"
            name="giveFreight"
            v-model.number="giveFreightData"
            v-on:change="checkGiveFreight"
            placeholder="0"
            style="width: 80px"
          />
          <input
            v-else
            min="0"
            type="number"
            name="giveFreight"
            v-model.number="giveFreightData"
            v-on:change="checkGiveFreight"
            placeholder="0"
            style="width: 80px"
          />
          元運費優惠
          <div class="explanation">
            請輸入滿條件後此筆訂單之運費，若輸入 50 元則此訂單之運費僅收 50
            元，若輸入 0 元則此訂單享有免運費優惠
          </div>
        </template>
        <template v-if="giveTypeData == 'gift'">
          <many-quick-search
            v-if="requestId"
            v-bind:search-only-match="'TRUE'"
            v-bind:select-items="preferentialGifts"
            v-bind:only-display="true"
          ></many-quick-search>
          <many-quick-search
            v-else
            v-bind:input-name="'giftName[]'"
            v-bind:search-input-name="'giftNameSearch'"
            v-bind:input-placeholder="'請輸入搜尋內容 ...'"
            v-bind:url="giftNamesQuickSearchLink"
            v-bind:search-only-match="'TRUE'"
          ></many-quick-search>
        </template>
      </div>
    </div>
  </div>
</template>

<script>
import ManyQuickSearchVue from '@fanswoo/core/vue/quick-search/many-quick-search.vue';
import EventBus from '@fanswoo/core/bootstrap/event-bus';

export default {
  props: [
    'preferentialGifts',
    'requestId',
    'giveType',
    'giveCoupon',
    'giveMoney',
    'giveDiscount',
    'giveFreight',
    'hasUserCoupon',
    'hasUserGift',
    'quickSearchLink',
  ],
  data: () => {
    return {
      giveMoneyData: 0,
      giveFreightData: 0,
      giveCouponData: 0,
      giveDiscountData: 0,
      giftNames: '',
      giftNamesQuickSearchLink: '',
      conditionMoney: 0,
      giveTypeData: 'money',
    };
  },
  components: {
    manyQuickSearch: ManyQuickSearchVue,
  },
  methods: {
    checkGiveDiscount: function () {
      if (this.giveDiscountData < 10) {
        this.giveDiscountData = 10;
      } else if (this.giveDiscountData > 99) {
        this.giveDiscountData = 99;
      }
    },
    checkGiveMoney: function () {
      if (this.giveMoneyData < 0) {
        this.giveMoneyData = 0;
      }

      if (this.conditionMoney > 0) {
        if (this.giveMoneyData > this.conditionMoney) {
          this.giveMoneyData = this.conditionMoney;
        }
      }
    },
    checkGiveFreight: function () {
      if (this.giveFreightData < 0) {
        this.giveFreightData = 0;
      }
    },
  },
  mounted() {
    this.giveTypeData = this.giveType || 'money';
    this.giveMoneyData = this.giveMoney || 0;
    this.giveFreightData = this.giveFreight || 0;
    this.giveCouponData = this.giveCoupon || 0;
    this.giveDiscountData = this.giveDiscount || 0;

    this.giftNamesQuickSearchLink =
      this.quickSearchLink.giftNamesQuickSearchLink;

    let _this = this;
    EventBus.$on('checkGiveMoney', function (conditionMoney) {
      _this.conditionMoney = conditionMoney;
    });
  },
  beforeDestroy() {
    EventBus.$off();
  },
};
</script>
