<template>
  <div class="col-12 px-0 mt-3">
    <button class="btn" @click.prevent="showModalAndSearchGiftItem($bvModal)">
      選取贈品
    </button>
    <div
      class="mt-3 row"
      v-for="selectedItem in selectedItems"
      :key="selectedItem.id"
    >
      <div class="col-3">
        <img :src="selectedItem.imgSrc" style="width: 50px; height: 50px" />
      </div>
      <div class="col-3">
        {{ selectedItem.name }}
        <input type="hidden" name="giftIds[]" :value="selectedItem.id" />
      </div>
      <div class="col-3">成本：$ {{ selectedItem.cost }}</div>
      <div class="col-3">庫存：{{ selectedItem.stocknum }}</div>
    </div>
    <div>
      <b-modal
        title="選取贈品"
        centered
        :id="`modal-gift-${index}`"
        size="lg"
        no-close-on-esc
        no-close-on-backdrop
        :header-class="['flex-column', 'align-items-stretch']"
        :modal-class="'z-index'"
      >
        <template v-slot:modal-header="{}">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="m-0">選取贈品</h5>
          </div>
          <div
            class="
              input-group
              d-flex
              justify-content-center
              align-items-center
              mb-3
            "
          >
            <div class="input-group-prepend">
              <select
                class="custom-select"
                name="itemSearchType"
                v-model="itemSearchTypeData"
              >
                <option
                  v-for="option in itemSearchTypeOptions"
                  :value="option.value"
                  :key="option.id"
                >
                  {{ option.text }}
                </option>
              </select>
            </div>
            <input
              type="text"
              class="form-control"
              placeholder="請輸入搜尋字詞"
              v-model="searchKeyword"
            />
            <div class="input-group-append">
              <button
                class="btn btn-outline-secondary"
                type="button"
                @click="searchGiftItem"
              >
                <font-awesome-icon icon="search" />
              </button>
            </div>
          </div>
        </template>
        <template v-slot:default="{}">
          <div v-if="searchingItems" class="text-center">
            <b-spinner label="Loading..."></b-spinner>
          </div>
          <template v-else>
            <div
              class="container-fluid content-row"
              v-if="searchItems.length > 0"
            >
              <div class="row">
                <div
                  class="col-12 col-sm-4 mb-3"
                  :key="index"
                  v-for="(item, index) in searchItems"
                  :current-page="currentPage"
                  :per-page="0"
                >
                  <div class="card h-100">
                    <div class="card h-100">
                      <img
                        :src="item.imgSrc"
                        class="card-img-top"
                        :alt="item.name"
                        style="height: auto"
                      />
                      <div class="card-body p-3">
                        <h6
                          class="card-title"
                          style="height: calc(12px * 3 * 1.2); overflow: hidden"
                        >
                          {{ item.name }}
                        </h6>
                        <div
                          class="
                            d-flex
                            justify-content-center
                            align-items-center
                          "
                        >
                          <input
                            type="checkbox"
                            :disabled="
                              tempSelectedItems.length > 0 &&
                              item.id !== tempSelectedItems[0].id
                            "
                            v-model="item.selected"
                            @change="syncTempSelectedItems(item)"
                            :id="`select-this-item${index}`"
                          />
                          <label
                            class="m-0 ml-1"
                            :for="`select-this-item${index}`"
                            >選擇</label
                          >
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <b-row class="justify-content-center">
                <b-col md="6" class="my-1">
                  <b-pagination
                    class="justify-content-center"
                    :total-rows="totalItemsCount"
                    v-model="currentPage"
                    :per-page="perPage"
                    @input="searchGiftItem"
                  ></b-pagination>
                </b-col>
              </b-row>
            </div>
            <div v-else class="text-center">
              <h4>查無結果</h4>
            </div>
          </template>
        </template>
        <template v-slot:modal-footer="{ ok, cancel }">
          <b-button
            size="sm"
            variant="primary"
            @click="
              ok();
              confirmSelectItems();
              searchKeyword = '';
            "
            >確定</b-button
          >
          <b-button
            size="sm"
            variant="secondary"
            @click="
              cancel();
              searchKeyword = '';
            "
            >取消</b-button
          >
        </template>
      </b-modal>
    </div>
  </div>
</template>

<script>
import EventBus from '@fanswoo/core/bootstrap/event-bus';
import LineTitle from '@fanswoo/control-center/custom-component/edit-control-center/line-content/base/line-title.vue';

const ItemSearchType = {
  NAME: 'name',
  TAG: 'tag',
  CLASS: 'class',
};

export default {
  components: {
    LineTitle,
  },
  props: {
    index: {
      type: Number,
      required: true,
    },
    itemClass: {
      type: String,
      default: 'gift',
    },
    currentSelectedItems: {
      type: Array,
      required: true,
    },
  },
  data: () => {
    return {
      ItemSearchType: {
        NAME: 'name',
        TAG: 'tag',
        CLASS: 'class',
      },

      itemSearchTypeData: ItemSearchType.NAME,

      searchKeyword: '',

      currentPage: 1,
      perPage: 6,
      searchItems: [],
      searchingItems: false,
      totalItemsCount: 0,

      tempSelectedItems: [],
      selectedItems: [],
      checkAllSelectedItems: false,
      selectItemsInThisPage: false,
      pageChanged: true,
    };
  },
  watch: {
    selectItemsInThisPage(value) {
      this.searchItems.forEach((item) => {
        item.selected = value;

        if (value) {
          this.pushToTempSelectedItems(item);
        } else {
          if (!this.pageChanged) {
            this.deleteFromTempSelectedItems(item);
          }
        }
      });

      this.pageChanged = false;
    },
    currentPage(value, oldValue) {
      this.pageChanged = true;
    },
    checkAllSelectedItems(value) {
      this.selectedItems.forEach((item) => {
        item.checkedForDelete = value;
      });
    },
  },
  computed: {
    itemSearchTypeOptions() {
      return [
        {
          id: 1,
          value: this.ItemSearchType.NAME,
          text: '透過名稱搜尋',
        },
        // {
        //   id: 2,
        //   value: this.ItemSearchType.TAG,
        //   text: "透過標籤搜尋"
        // },
        // {
        //   id: 3,
        //   value: this.ItemSearchType.CLASS,
        //   text: "透過分類搜尋"
        // }
      ];
    },
    tempSelectedItemIds() {
      return this.pluck('id', this.tempSelectedItems);
    },
    hasItemsToDeleted() {
      return this.selectedItems.some((item) => {
        return item.checkedForDelete;
      });
    },
  },
  methods: {
    syncTempSelectedItems(item) {
      if (item.selected) {
        this.pushToTempSelectedItems(item);
      } else {
        this.deleteFromTempSelectedItems(item);
      }
    },
    pushToTempSelectedItems(item) {
      let tempSelectedItemIndex = this.tempSelectedItems.findIndex(
        (tempSelectedItem) => {
          return tempSelectedItem.id == item.id;
        },
      );

      if (tempSelectedItemIndex === -1) {
        this.tempSelectedItems.push(item);
      }
    },
    deleteFromTempSelectedItems(item) {
      let tempSelectedItemIndex = this.tempSelectedItems.findIndex(
        (tempSelectedItem) => {
          return tempSelectedItem.id == item.id;
        },
      );

      if (tempSelectedItemIndex !== -1) {
        this.tempSelectedItems.splice(tempSelectedItemIndex, 1);
      }
    },
    showModalAndSearchGiftItem(bvModal) {
      bvModal.show(`modal-gift-${this.index}`);

      this.currentPage = 1;
      this.searchGiftItem();
    },
    async searchGiftItem() {
      this.tempSelectedItems = [];
      this.searchingItems = true;

      axios
        .get(
          `gift-item/${this.itemSearchTypeData}/${this.itemClass}?keyword=${
            this.searchKeyword
          }&offset=${(this.currentPage - 1) * this.perPage}&limit=${
            this.perPage
          }`,
        )
        .then((res) => {
          this.searchItems = res.data.items;
          let sameCount = 0;
          for (let searchItem of this.searchItems) {
            if (this.tempSelectedItemIds.indexOf(searchItem.id) !== -1) {
              searchItem.selected = true;
              sameCount++;
            }
          }
          if (sameCount == this.searchItems.length) {
            this.selectItemsInThisPage = true;
          } else {
            this.selectItemsInThisPage = false;
          }
          this.totalItemsCount = res.data.totalCount;
          this.searchingItems = false;
        })
        .catch((err) => {
          this.searchingItems = false;
        });
    },
    confirmSelectItems() {
      this.selectedItems = JSON.parse(JSON.stringify(this.tempSelectedItems));
    },
    deleteSelectedItem(item) {
      let selectedItemIndex = this.selectedItems.findIndex((selectedItem) => {
        return selectedItem.id == item.id;
      });

      this.selectedItems.splice(selectedItemIndex, 1);

      let tempSelectedItemIndex = this.tempSelectedItems.findIndex(
        (tempSelectedItem) => {
          return tempSelectedItem.id == item.id;
        },
      );

      this.tempSelectedItems.splice(tempSelectedItemIndex, 1);

      if (this.selectedItems.length == 0) {
        this.checkAllSelectedItems = false;
      }
    },
    deleteCheckedSelectedItems() {
      this.selectedItems = this.selectedItems.filter((item) => {
        return !item.checkedForDelete;
      });

      this.checkAllSelectedItems = false;

      this.tempSelectedItems = JSON.parse(JSON.stringify(this.selectedItems));
    },
    widthStyle(n) {
      let width = 50 * n;
      return {
        minWidth: `${width}px`,
        maxWidth: `${width}px`,
      };
    },
    pluck(column, array) {
      return array.map((item) => {
        return item[column];
      });
    },
  },
  mounted() {
    if (this.currentSelectedItems[0]) {
      this.selectedItems = this.currentSelectedItems;
    } else {
      this.selectedItems = this.selectedItems;
    }
  },
  updated() {},
  beforeDestroy() {
    EventBus.$off();
  },
};
</script>

<style scoped lang="scss">
.input-group-append {
  height: 30px;
}

.class-display ul {
  padding: 0;
  list-style: none;
  border: 1px solid #ccc;
}

.custom-select {
  height: 30px;
  margin: 0;
}

// .edit-content .line-content .field select {
//   height: 30px;
//   margin: 0;
// }

.btn {
  border: 1px solid #ccc;
}

.item-search-type .input-group {
  width: 100%;
  @media (min-width: 768px) {
    width: 50%;
  }
}

[id$='BV_modal_outer_'] {
  z-index: 9999 !important;
}

.scrollable {
  overflow-x: scroll;
}

.table th,
.table td {
  border-top: 0;
  border-bottom: 1px solid #dee2e6;
  padding-left: 1.25rem;
}

input[type='text'],
input[type='number'],
input[type='password'] {
  height: auto;
}
</style>
