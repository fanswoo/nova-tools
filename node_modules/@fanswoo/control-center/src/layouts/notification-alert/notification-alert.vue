<template>
  <div class="notification" @click="onClickNotificationPopover">
    <span v-if="notificationTotalCount > 0" v-cloak class="count">
      {{ notificationTotalCount }}
    </span>
  </div>
</template>

<script>
import { useStore } from '@/control-center/store/control-center-store';
const store = useStore();

export default {
  data() {
    return {
      readAllHref: 'userCenter/my/user/notification/list',
      searching: false,
      canSearchMore: false,
      // totalCount: 0,
      Notifys: [],
      isFocus: false,
      originalTitle: '',
      currentTitle: '',
      titleHandler: null,
    };
  },
  computed: {
    notificationPopoverOpened: {
      get() {
        return store.state.RoutePage.notificationPopoverOpened;
      },
      set(value) {
        store.commit('RoutePage/setNotificationPopoverOpened', value);
      },
    },
    notificationTotalCount: {
      get() {
        return store.state.RoutePage.notificationTotalCount;
      },
      set(value) {
        store.commit('RoutePage/setNotificationTotalCount', value);
      },
    },
  },
  created() {
    this.isFocus = document.hasFocus();
    // var _this = this;
    // console.log(this.isFocus, document.hasFocus());
    window.onfocus = () => {
      this.isFocus = true;
      this.changeFavicon('img/favicon.ico');
      //   this.playNotificationSound(new Audio());
      //   if (this.titleHandler) {
      //     clearInterval(this.titleHandler);
      //   }
      //   this.changeTitle(this.originalTitle);

      //   console.log(this.isFocus, "F");
    };

    window.onblur = () => {
      //   this.changeFavicon("img/favicon2.ico");
      this.isFocus = false;
      //   console.log(this.isFocus, "B");
    };
  },
  mounted() {
    this.originalTitle = document.querySelector('title').text;
    this.currentTitle = document.querySelector('title').text;
    this.bindEcho();

    this.changeResult();

    document.addEventListener('click', this.onClickNotificationPopover, false);
  },
  methods: {
    // // 根據查詢變更結果
    async changeResult() {
      if (this.searching === true) {
        return false;
      }

      this.searching = true;
      this.Notifys = [];
      const data = {};

      const response = await this.getPageDataResponse(
        `${$('base').attr('href')}api/notification/getListJson`,
        data,
      );

      const pageData = response.data;

      if (pageData.Notifys && pageData.Notifys.length > 0) {
        this.Notifys = pageData.Notifys;

        this.searching = false;

        // this.totalCount = pageData.totalCount;

        if (pageData.Notifys.length < pageData.count) {
          this.canSearchMore = 'no';
        } else {
          this.canSearchMore = 'yes';
        }
      } else {
        this.searching = false;
        this.canSearchMore = 'no';
      }

      return true;
    },
    changeTitle(message) {
      const title = document.querySelector('title');
      title.text = message;
      this.currentTitle = title.text;
      document.getElementsByTagName('head')[0].appendChild(title);
      //   console.log(title.text);
    },
    changeFavicon(faviconPath) {
      const link = document.querySelector("link[rel*='icon']");
      link.type = 'image/x-icon';
      link.rel = 'shortcut icon';
      link.href = faviconPath;
      document.getElementsByTagName('head')[0].appendChild(link);
    },
    playNotificationSound(Audio) {
      // Audio.src = "audio/j45RzFrAzdD.mp3";
      window.Audio.src = 'audio/notification.mp3';

      const playPromise = window.Audio.play();
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            Audio.play();
          })
          .catch(() => {});
      }
    },
    async getPageDataResponse(link, data) {
      let response;
      try {
        response = await axios.get(link, data);
      } catch (error) {
        console.warn(error);
      }

      return response;
    },
    onClickNotificationPopover(event) {
      // 點擊通知圖示或數字
      if (
        $(event.target).hasClass('notification') === true ||
        ($(event.target).hasClass('count') === true &&
          $(event.target).parents('.header-bar .notification').length > 0)
      ) {
        if (this.notificationPopoverOpened) {
          store.commit('RoutePage/setNotificationPopoverOpened', false);
        } else {
          store.commit('RoutePage/setNotificationPopoverOpened', true);
        }

        event.stopPropagation();
      } else if (
        $(event.target).hasClass('notification') === false &&
        $(event.target).parents('.notification-popover .item .read-it')
          .length === 0 &&
        $(event.target).parents('.notification-popover').length > 0
      ) {
        event.stopPropagation();
      } else {
        store.commit('RoutePage/setNotificationPopoverOpened', false);
      }

      // if ($(".notification-popover").css("display") == "none") {
      //     $(".notification-popover").css("display", "block");
      // } else {
      //     $(".notification-popover").css("display", "none");
      // }
    },
    bindEcho() {
      if (
        window.location.host !== '127.0.0.1' &&
        window.location.host !== 'localhost' &&
        window.Echo !== undefined
      ) {

        // channel 第一個參數填寫 User class path
        // channel 綁定的參數必須跟 Laravel Echo 綁定同樣位置
        window.Echo.private(
          `App.User.User.${window.Json.User.id}`,
        ).notification(() => {
          // 收到通知時如果瀏覽器是沒有聚焦的，則改變favicon以及發出聲響
          // 收到通知時如果瀏覽器是聚焦的，則發出聲響
          // 收到通知後用戶如果再次聚焦瀏覽器，則變回原來的favicon
          //   console.log(this.isFocus);
          if (this.isFocus) {
            this.playNotificationSound(new Audio());
          } else {
            // 瀏覽器聚焦時 不改變icon
            this.changeFavicon('img/favicon-notification.ico');
            this.playNotificationSound(new Audio());
          }
          this.changeResult();
        });
      }
    },
  },
};
</script>
