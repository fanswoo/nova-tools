<template>
  <!-- style="display:none;" -->
  <div
    :class="{
      'notification-popover': true,
      popover: true,
      'bs-popover-bottom': true,
      opened: notificationPopoverOpened,
    }"
    role="tooltip"
  >
    <div class="arrow"></div>
    <h3 class="popover-header">
      <div v-if="totalCount > 0" class="read-all" @click="onClickReadAll">
        全部標示已讀 ( {{ totalCount }} )
      </div>
      系統通知
    </h3>
    <div class="popover-body">
      <transition-group name="fade" tag="div">
        <template v-for="(Notify, key) in Notifys" :key="key">
          <div
            class="item"
            :ff-notifyId="Notify.id"
            @click="onClickReadItem(Notify.id)"
          >
            <h5>
              <span class="read-it" @click.stop="onClickReadItAction(Notify.id)"
                >標記已讀</span
              >
              {{ Notify.title }}
            </h5>
            <p>{{ Notify.content }}</p>
            <span class="updated-at">{{ Notify.updatedAt }}</span>
          </div>
        </template>
      </transition-group>
      <div v-if="searching" class="search-status">資料搜尋中 ...</div>
      <div v-else-if="totalCount === 0" class="search-status">
        您目前沒有未讀的通知
      </div>
      <div v-else-if="canSearchMore === 'no'" class="search-status">
        您沒有其它未讀的通知
      </div>
    </div>
    <a :href="readAllHref" class="read-more"> 查看全部 </a>
  </div>
</template>

<script>
import Echo from 'laravel-echo';
import { useStore } from '@/control-center/store/control-center-store';
const store = useStore();

export default {
  data() {
    return {
      readAllHref: 'userCenter/my/user/notification/list',
      searching: false,
      canSearchMore: false,
      totalCount: 0,
      Notifys: [],
      isFocus: false,
      originalTitle: '',
      currentTitle: '',
      titleHandler: null,
    };
  },
  computed: {
    notificationPopoverOpened: {
      get() {
        return store.state.RoutePage.notificationPopoverOpened;
      },
      set(value) {
        store.commit('RoutePage/setNotificationPopoverOpened', value);
      },
    },
    notificationTotalCount: {
      get() {
        return store.state.RoutePage.notificationTotalCount;
      },
      set(value) {
        store.commit('RoutePage/setNotificationTotalCount', value);
      },
    },
  },
  created() {
    this.isFocus = document.hasFocus();
    // var _this = this;
    // console.log(this.isFocus, document.hasFocus());
    window.onfocus = () => {
      this.isFocus = true;
      this.changeFavicon('img/favicon.ico');
      //   this.playNotificationSound(new Audio());
      //   if (this.titleHandler) {
      //     clearInterval(this.titleHandler);
      //   }
      //   this.changeTitle(this.originalTitle);

      //   console.log(this.isFocus, "F");
    };

    window.onblur = () => {
      //   this.changeFavicon("img/favicon2.ico");
      this.isFocus = false;
      //   console.log(this.isFocus, "B");
    };
  },
  mounted() {
    this.originalTitle = document.querySelector('title').text;
    this.currentTitle = document.querySelector('title').text;
    this.bindEcho();

    this.changeResult();
    // $(".header-bar .notification").disableSelection();

    document
      .querySelector('.notification-popover .popover-body')
      .addEventListener('scroll', this.onScrollNotificationPoverBody, true);
  },
  methods: {
    // 根據查詢增加結果
    async addResult() {
      if (this.searching === true || this.canSearchMore === 'no') {
        return false;
      }

      this.searching = true;

      const data = {
        idNotIn: [],
      };

      for (let i = 0; i < this.Notifys.length; i += 1) {
        data.idNotIn.push(this.Notifys[i].id);
      }

      const response = await this.getPageDataResponse(
        `${$('base').attr('href')}api/notification/getListJson`,
        data,
      );

      const pageData = response.data;

      this.searching = false;

      this.totalCount = pageData.totalCount;
      store.commit(
        'RoutePage/setNotificationTotalCount',
        this.totalCount,
      );

      if (pageData.Notifys && pageData.Notifys.length > 0) {
        for (let i = 0; i < pageData.Notifys.length; i += 1) {
          this.Notifys.push(pageData.Notifys[i]);
        }
      } else {
        this.canSearchMore = 'no';
      }
      return true;
    },
    // // 根據查詢變更結果
    async changeResult() {
      if (this.searching === true) {
        return false;
      }

      this.searching = true;
      this.Notifys = [];
      const data = {};

      const response = await this.getPageDataResponse(
        `${$('base').attr('href')}api/notification/getListJson`,
        data,
      );

      const pageData = response.data;

      if (pageData.Notifys && pageData.Notifys.length > 0) {
        this.Notifys = pageData.Notifys;

        this.searching = false;

        this.totalCount = pageData.totalCount;
        store.commit(
          'RoutePage/setNotificationTotalCount',
          this.totalCount,
        );

        if (pageData.Notifys.length < pageData.count) {
          this.canSearchMore = 'no';
        } else {
          this.canSearchMore = 'yes';
        }
      } else {
        this.searching = false;
        this.canSearchMore = 'no';
      }
      return true;
    },
    changeTitle(message) {
      const title = document.querySelector('title');
      title.text = message;
      this.currentTitle = title.text;
      document.getElementsByTagName('head')[0].appendChild(title);
      //   console.log(title.text);
    },
    changeFavicon(faviconPath) {
      const link = document.querySelector("link[rel*='icon']");
      link.type = 'image/x-icon';
      link.rel = 'shortcut icon';
      link.href = faviconPath;
      document.getElementsByTagName('head')[0].appendChild(link);
    },
    playNotificationSound(Audio) {
      // Audio.src = "audio/j45RzFrAzdD.mp3";
      window.Audio.src = 'audio/notification.mp3';

      const playPromise = Audio.play();
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            Audio.play();
          })
          .catch(() => {});
      }
    },
    async getPageDataResponse(link, data) {
      let response;
      try {
        response = await axios.post(link, data);
      } catch (error) {
        console.warn(error);
      }

      return response;
    },
    onScrollNotificationPoverBody() {
      if (
        $('.notification-popover .popover-body').scrollTop() !== 0 &&
        Math.ceil(
          $('.notification-popover .popover-body').scrollTop() +
            $('.notification-popover .popover-body').height() +
            300,
        ) >= Math.ceil($('.notification-popover .popover-body')[0].scrollHeight)
      ) {
        this.addResult();
      }
    },
    onClickReadAll() {
      store.commit('RoutePage/setNotificationPopoverOpened', false);
      this.Notifys = [];
      this.totalCount = 0;
      store.commit(
        'RoutePage/setNotificationTotalCount',
        this.totalCount,
      );
      $.ajax({
        url: `${$('base').attr('href')}api/notification/readAll`,
        type: 'POST',
        dataType: 'json',
      })
        .done(() => {})
        .fail(() => {});
    },
    async onClickReadItAction(notifyId) {
      for (let i = 0; i < this.Notifys.length; i += 1) {
        if (this.Notifys[i].id === notifyId) {
          this.Notifys.splice(i, 1);
          $.ajax({
            url: `${$('base').attr(
              'href',
            )}api/notification/readById?id=${notifyId}`,
            type: 'POST',
            dataType: 'json',
          }).done((response) => {
            const data = JSON.parse(JSON.stringify(response));
            this.totalCount = data.totalCount;
            store.commit(
              'RoutePage/setNotificationTotalCount',
              this.totalCount,
            );
          });

          return true;
        }
      }
      return false;
    },
    bindEcho() {
      if (
        window.location.host !== '127.0.0.1' &&
        window.location.host !== 'localhost' &&
        window.Echo !== undefined &&
        Json.pusherAppKey
      ) {
        window.Echo = new Echo({
          broadcaster: 'pusher',
          key: Json.pusherAppKey,
          cluster: 'us2',
          encrypted: true,
          authEndpoint: `${window.Json.url}/broadcasting/auth`,
        });

        // channel 第一個參數填寫 User class path
        // channel 綁定的參數必須跟 Laravel Echo 綁定同樣位置
        window.Echo.private(`App.User.User.${Json.User.id}`).notification(
          () => {
            // 收到通知時如果瀏覽器是沒有聚焦的，則改變favicon以及發出聲響
            // 收到通知時如果瀏覽器是聚焦的，則發出聲響
            // 收到通知後用戶如果再次聚焦瀏覽器，則變回原來的favicon
            //   console.log(this.isFocus);
            if (this.isFocus) {
              this.playNotificationSound(new Audio());
            } else {
              // 瀏覽器聚焦時 不改變icon
              this.changeFavicon('img/favicon-notification.ico');
              this.playNotificationSound(new Audio());
              // let message = "您收到新的通知";
              // if (!this.titleHandler) {
              //   this.titleHandler = setInterval(() => {
              //     // console.log(this.isFocus);
              //     if (!this.isFocus) {
              //       this.changeTitle(
              //         this.currentTitle != message ? message : this.originalTitle
              //       );
              //     }
              //   }, 2000);
              // }
            }
            this.changeResult();
          },
        );
      }
    },
    onClickReadItem(notifyId) {
      for (let i = 0; i < this.Notifys.length; i += 1) {
        if (this.Notifys[i].id === notifyId) {
          window.location.href = `${$('base').attr(
            'href',
          )}api/notification/readToPage?id=${notifyId}`;
          return false;
        }
      }
      return true;
    },
  },
};
</script>
