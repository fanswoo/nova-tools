<template>
  <div>
    <div
      :class="[
        'header-bar-close-bg',
        headerBarCloseBgOpacity ? 'opacity1' : 'opacity0',
      ]"
      :style="{
        display: headerBarCloseBgDisplay ? 'block' : 'none',
      }"
      @click="onMenuClick"
    />
    <div class="header-bar-left-swipe-area"></div>
    <div
      :class="{
        'side-bar': true,
        'sidebar-opened': sidebarOpened,
      }"
    >
      <HeaderBar/>
      <UserStatus/>
<!--      <SideBarBody/>-->
      <SideBarFooter/>
    </div>
<!--    <NotificationAlertPopover v-if="hasNotification"/>-->
  </div>
</template>

<script setup lang="ts">
import { ref, watch, inject, computed, onMounted } from 'vue';
import { useStore } from '@/control-center/store/control-center-store';
import { getCurrentInstance } from 'vue';
import NotificationAlertPopover
  from '@fanswoo/control-center/layouts/notification-alert/notification-alert-popover.vue';
import { ComponentLoader } from '@fanswoo/component-loader/main';
import { setSidebarOpenedCookie } from '@fanswoo/control-center/utils/common-helpers';

const store = useStore();
const adminSidebox = inject('adminSidebox');
const sidebarDefaultImgSrc = inject('sidebarDefaultImgSrc');
const hasNotification = inject('hasNotification');
const urlRootPath = inject('urlRootPath');
const sidebarOpened = computed(() => store.state.RoutePage.sidebarOpened);
const notificationPopoverOpened = ref(store.state.RoutePage.notificationPopoverOpened);

const isLargeScreen = ref(false);
const headerBarCloseBgDisplay = ref(false);
const headerBarCloseBgOpacity = ref(true);

const setSidebarOpened = (state) => {
  store.commit('RoutePage/setSidebarOpened', state);
}

const onMenuClick = () => {
  if (sidebarOpened.value) {
    setSidebarOpened(false);
  } else {
    setSidebarOpened(true);
  }
}

const loader = ComponentLoader.getInstance();
const vueInstance = getCurrentInstance();
const route = computed(() => vueInstance.proxy.$route);
const router = computed(() => vueInstance.proxy.$router);

const setRouteQuerySidebarOpened = () => {
  const query: {
    sidebarOpened?: string | null;
  } = {
    sidebarOpened: null,
  };

  for (let key in route.value.query) {
    query[key] = route.value.query[key];
  }

  if (sidebarOpened.value) {
    query.sidebarOpened = null;
  } else {
    delete query.sidebarOpened;
  }

  router.value
    .push({
      path: route.value.path,
      query: query,
    })
    .catch((error) => {});
}

const toggleHeaderBarMenu = () => {
  if (sidebarOpened.value) {
    $('.body-content').addClass('sidebar-opened');

    if ($(window).width()! < 768) {
      headerBarCloseBgDisplay.value = true;
      headerBarCloseBgOpacity.value = true;
      setRouteQuerySidebarOpened();
    } else {
      const oldDateObj = new Date();
      const newDateObj = new Date();
      newDateObj.setTime(oldDateObj.getTime() + 60 * 60 * 24 * 30 * 1000);
      setSidebarOpenedCookie(true);
    }
  } else {
    $('.body-content').removeClass('sidebar-opened');

    if ($(window).width()! < 768) {
      headerBarCloseBgOpacity.value = false;
      setRouteQuerySidebarOpened();

      setTimeout(() => {
        if ($('.header-bar-close-bg').hasClass('opacity0')) {
          headerBarCloseBgDisplay.value = false;
        }
      }, 300);
    } else {
      setSidebarOpenedCookie(false);
    }
  }
};

const onWindowResize = () => {
  if ($(window).width()! >= 768) {
    isLargeScreen.value = true;
  } else {
    isLargeScreen.value = false;
  }

  store.commit('RoutePage/setNotificationPopoverOpened', false);
  setSidebarOpened(false);
  toggleHeaderBarMenu();
};

watch(sidebarOpened, () => {
  toggleHeaderBarMenu();
  store.commit('RoutePage/setNotificationPopoverOpened', false);
});

if(!vueInstance.proxy.$.components) {
  vueInstance.proxy.$.components = [];
}
_.merge(vueInstance.proxy.$.components, loader.loadComponents([
  {
    pageName: urlRootPath,
    themeName: 'layout',
    typeName: 'layout',
  }]));

onMounted(() => {

  if ($(window).width()! >= 768) {
    isLargeScreen.value = true;
  }

  window.addEventListener('resize', onWindowResize, false);

  if ($(window).width()! < 768) {
    setSidebarOpened(false);

    router.value.afterEach((to, from) => {
      if (to.query.sidebarOpened !== undefined) {
        setSidebarOpened(true);
      } else {
        setSidebarOpened(false);
      }
    });

    $('.header-bar-left-swipe-area').on('swiperight', (event) => {
      if (!sidebarOpened.value) {
        setSidebarOpened(true);
      }
    });
    $('.SideBarContent.sidebar-opened').on('swipeleft', (event) => {
      if (sidebarOpened.value) {
        setSidebarOpened(false);
      }
    });
  }
});
</script>
