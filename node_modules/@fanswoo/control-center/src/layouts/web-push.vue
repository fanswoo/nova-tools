<template>
  <b-modal
    ref="checkSubscribe"
    id="check-subscribe"
    no-close-on-backdrop
    hide-header-close
    size="sm"
  >
    <template v-slot:modal-header="">
      <h5>請依序開啟瀏覽器通知</h5>
    </template>
    <template>
      <p>1. 點選網址列左方圖示「查看網站資訊」</p>
      <p>2. 點選通知選項，並開啟通知功能</p>
      <p>3. 重新整理目前的頁面</p>
    </template>
    <template v-slot:modal-footer="">
      <button class="btn btn-md btn-primary" onclick="location.reload()">
        重新整理頁面
      </button>
    </template>
  </b-modal>
</template>

<script>
export default {
  methods: {
    bindServiceWork() {
      if ('serviceWorker' in navigator && 'PushManager' in window) {
        navigator.serviceWorker
          .register($('base').attr('href') + 'service-worker.js')
          .then((reg) => {
            if (
              (window.PushManager &&
                Json.User &&
                Json.User.UserGroupTraits &&
                Json.User.UserGroupTraits.notification == 'on') ||
              (window.PushManager &&
                Json.User &&
                Json.User.UserGroupTraits &&
                Json.User.UserGroupTraits.notification == 'force')
            ) {
              if (
                Notification.permission !== 'granted' &&
                Json.User.UserGroupTraits &&
                Json.User.UserGroupTraits.notification == 'force'
              ) {
                this.$refs.checkSubscribe.show();
                Notification.requestPermission();
              }

              reg.pushManager.getSubscription().then((subscription) => {
                let isSubscribed = !(subscription === null);
                // 如果用戶有訂閱
                if (isSubscribed) {
                  this.connectSubscribe(subscription);
                } else {
                  this.subscribeUser(reg);
                }
              });
            }
          })
          .catch((err) => {
            if (location.host !== 'localhost') {
              console.warn(err);
            }
          });
      }
    },
    subscribeUser(swRegistration) {
      const applicationServerPublicKey = Json.vapidPublicKey;

      if (!applicationServerPublicKey) {
        return false;
      }

      const applicationServerKey = this.urlB64ToUint8Array(
        applicationServerPublicKey,
      );
      swRegistration.pushManager
        .subscribe({
          userVisibleOnly: true,
          applicationServerKey: applicationServerKey,
        })
        // .then(function (subscription) {
        //     return subscription;
        // })
        .then((subscription) => {
          this.connectSubscribe(subscription);
        })
        // 用戶不同意或者生成失敗
        .catch(function (err) {
          console.log('Failed to subscribe the user: ', err);
        });
    },
    connectSubscribe(subscription) {
      var subscriptionStringify = JSON.stringify(subscription);
      $.ajax({
        url: $('base').attr('href') + 'api/webpush/connectSubscribe',
        type: 'POST',
        data: {
          subscription: subscriptionStringify,
        },
        dataType: 'json',
      }).done(function (response) {
        console.log(response);
      });
    },
    urlB64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/');

      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);

      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    },
  },
  mounted: function () {
    this.bindServiceWork();
  },
};
</script>

<style lang="scss">
#check-subscribe___BV_modal_outer_ {
  z-index: 99999 !important;
}
</style>
