<script>
export default {
  data() {
    return {
      Order: Json.Order,
      Transports: Json.Transports,
      AllTransports: Json.Transports,
      userCoupon: Json.userCoupon,
      useCoupon: 0,
      couponCountRuleForUse: Json.couponCountRuleForUse,
      couponCountRuleCanUse: Json.couponCountRuleCanUse,
      discountCode: null,
      discountCodeId: null,
      discountCodeText: '',
      processing: false,
      discountCodePreferentials: Json.discountCodePreferentials,
    };
  },
  computed: {
    isPreferentialDiscountCodeFilled() {
      return (
        this.discountCode != null &&
        this.discountCode !== '' &&
        this.discountCode !== 0
      );
    },
    usedPreferentials() {
      return this.Order.usedPreferentials.filter(
        ({ isPreferentialAvailable }) => isPreferentialAvailable,
      );
    },
  },
  watch: {
    useCoupon() {
      if (this.useCoupon > this.userCoupon) {
        this.useCoupon = this.userCoupon;
      }

      if (this.useCoupon > this.couponCountRuleCanUse) {
        this.useCoupon = this.couponCountRuleCanUse;
      }

      if (
        this.useCoupon >
        this.Order.cartPriceTotal +
          this.Order.payPriceFreight -
          this.Order.tradeinCount -
          1
      ) {
        this.useCoupon =
          this.Order.cartPriceTotal +
          this.Order.payPriceFreight -
          this.Order.tradeinCount -
          1;
      }

      if (this.useCoupon < 0) {
        this.useCoupon = 0;
      }
    },
  },
  mounted() {
    // $('[data-toggle="popover"]').popover({
    //   html: true,
    //   trigger: "hover",
    //   placement: "top"
    // });
    this.changeCartsPriceTotal();
    // this.resetGiftCart();
  },
  methods: {
    changeCartAmount(key) {
      this.processing = true;

      if (
        Number.isNaN(this.Order.Carts[key].amount) ||
        this.Order.Carts[key].amount < 1
      ) {
        // 防止前台填入負值或是非數字字元
        this.Order.Carts[key].amount = 1;
      }

      if (
        this.Order.Carts[key].Product.endOfSale !== 'preOrder' &&
        this.Order.Carts[key].Product.purchaseLowerLimit > 0 &&
        this.Order.Carts[key].amount <
          this.Order.Carts[key].Product.purchaseLowerLimit
      ) {
        this.Order.Carts[key].amount =
          this.Order.Carts[key].Product.purchaseLowerLimit;
      }

      if (
        this.Order.Carts[key].Product.endOfSale !== 'preOrder' &&
        this.Order.Carts[key].Product.purchaseUpperLimit > 0 &&
        this.Order.Carts[key].amount >
          this.Order.Carts[key].Product.purchaseUpperLimit
      ) {
        this.Order.Carts[key].amount =
          this.Order.Carts[key].Product.purchaseUpperLimit;
      }

      if (
        this.Order.Carts[key].Product.endOfSale === 'preOrder' &&
        // this.ShoppingOrder.Carts[key].amount > this.ShoppingOrder.Carts[key].Specification.stocknum &&
        this.Order.Carts[key].Product.preOrderLowerLimit > 0 &&
        this.Order.Carts[key].amount <
          this.Order.Carts[key].Product.preOrderLowerLimit
      ) {
        this.Order.Carts[key].amount =
          this.Order.Carts[key].Product.preOrderLowerLimit;
      }

      if (
        this.Order.Carts[key].Product.endOfSale === 'preOrder' &&
        // this.ShoppingOrder.Carts[key].amount > this.ShoppingOrder.Carts[key].Specification.stocknum &&
        this.Order.Carts[key].Product.preOrderUpperLimit > 0 &&
        this.Order.Carts[key].amount >
          this.Order.Carts[key].Product.preOrderUpperLimit
      ) {
        this.Order.Carts[key].amount =
          this.Order.Carts[key].Product.preOrderUpperLimit;
      }

      if (
        this.Order.Carts[key].amount >
          this.Order.Carts[key].Specification.stocknum &&
        this.Order.Carts[key].Product.endOfSale !== 'preOrder'
      ) {
        // 防止填寫超過庫存量，但是預購商品除外
        this.Order.Carts[key].amount =
          this.Order.Carts[key].Specification.stocknum;
      }

      $.ajax({
        url: 'shop/order/cart/changeCartAmount',
        type: 'POST',
        data: {
          cartId: this.Order.Carts[key].id,
          amount: this.Order.Carts[key].amount,
          orderId: this.Order.id,
        },
        dataType: 'json',
      })
        .done((response) => {
          this.Order.isFreeFreight = response.isFreeFreight;
          this.Order.tradeinCount = response.tradeinCount;
          this.Order.payCartPriceTotal = response.payCartPriceTotal;
          this.Order.payPriceFreight = response.payPriceFreight;
          this.Order.hasExecuteFreight = response.hasExecuteFreight;
          this.Order.usedPreferentials = response.usedPreferentials;
          // this.ShoppingOrder.CartGifts = response.GiftCarts;
          this.Order.Carts[key].priceTotal =
            this.Order.Carts[key].Specification.price *
            this.Order.Carts[key].amount;

          this.changeCartsPriceTotal();
          this.processing = false;
        })
        .fail(() => {
          this.processing = false;
        });
    },
    // 計算購物車總金額
    changeCartsPriceTotal() {
      let priceTotal = 0;
      if (this.Order) {
        this.Order.Carts.forEach((cart) => {
          if (cart.Specification && cart.Specification.price && cart.amount) {
            const cartPriceTotal =
              parseInt(cart.Specification.price, 10) *
              parseInt(cart.amount, 10);
            priceTotal += cartPriceTotal;
          }
        });
      }
      if (priceTotal) {
        this.Order.cartPriceTotal = priceTotal;
        this.Order.payCartPriceTotal = priceTotal;
      }
      this.updateTransport();
      this.changeTransport();
      // this.useCoupon = 0;
      this.getOrderChanges();
    },
    // 計算購物車總金額
    updateTransport() {
      // 如果這個訂單的金額不符合目前訂單所選擇的運輸金額限制，則更換一個運輸方式

      const rejectKey = [];
      const filterId = [];
      for (let key in this.AllTransports) {
        if (
          (this.AllTransports[key].priceLowerLimit == 0 &&
            this.AllTransports[key].priceUpperLimit != 0 &&
            this.Order.payCartPriceTotal >
              this.AllTransports[key].priceUpperLimit) ||
          (this.AllTransports[key].priceLowerLimit != 0 &&
            this.AllTransports[key].priceUpperLimit == 0 &&
            this.Order.payCartPriceTotal <
              this.AllTransports[key].priceLowerLimit) ||
          (this.AllTransports[key].priceLowerLimit != 0 &&
            this.AllTransports[key].priceUpperLimit != 0 &&
            (this.Order.payCartPriceTotal <
              this.AllTransports[key].priceLowerLimit ||
              this.Order.payCartPriceTotal >
                this.AllTransports[key].priceUpperLimit))
        ) {
          rejectKey.push(key);
        } else {
          filterId.push(this.AllTransports[key].id);
        }

        this.Transports = Object.keys(this.AllTransports)
          .filter((key) => !rejectKey.includes(key))
          .reduce((obj, key) => {
            obj[key] = this.AllTransports[key];
            return obj;
          }, {});
      }

      if (filterId.length !== 0 && !filterId.includes(this.Order.transportId)) {
        this.Order.transportId =
          this.Transports[Object.keys(this.Transports)[0]].id;
      }
    },
    // 變更運送及運費計算
    changeTransport() {
      for (let key in this.Transports) {
        if (this.Transports[key].id == this.Order.transportId) {
          this.Order.Transport.basePrice = this.Transports[key].basePrice;
          this.Order.Transport.additionalPrice =
            this.Transports[key].additionalPrice;

          var amountTotal = 0;
          for (let cartKey in this.Order.Carts) {
            amountTotal += parseInt(this.Order.Carts[cartKey].amount);
          }

          if (this.Order.isFreeFreight) {
            this.currentPayPriceFreight = this.Order.payPriceFreight = 0;
          } else if (this.Order.hasExecuteFreight) {
            this.currentPayPriceFreight = this.Order.payPriceFreight;
          } else {
            this.currentPayPriceFreight = this.Order.payPriceFreight =
              this.Order.Transport.basePrice +
              this.Order.Transport.additionalPrice * amountTotal;
          }

          // this.getOrderChanges();
        }
      }
      this.changePayPriceTotal();
    },
    // 計算訂單總金額
    getOrderChanges() {
      axios
        .get('shop/order/cart/getOrderChanges')
        .then((response) => {
          this.handlePreferentialDiscountCode(
            response.data.DiscountCodePreferentialInformations,
          );

          this.Order.isFreeFreight = response.data.isFreeFreight;

          this.Order.tradeinCount = response.data.tradeinCount;

          this.Order.payCartPriceTotal = response.data.payCartPriceTotal;

          this.Order.payPriceFreight = response.data.payPriceFreight;

          this.Order.hasExecuteFreight = response.data.hasExecuteFreight;

          this.Order.usedPreferentials = response.data.usedPreferentials;

          this.Order.payPriceTotal =
            response.data.payCartPriceTotal +
            this.Order.payPriceFreight -
            response.data.tradeinCount -
            this.useCoupon;

          this.Order.GiftCarts = response.data.GiftCarts;

          this.Order.Combinations = response.data.Combinations;

          for (let i = 0; i < this.Order.Combinations.length; i += 1) {
            this.Order.Combinations[i].priceTotal =
              this.Order.Combinations[i].price *
              this.Order.Combinations[i].amount;
            this.Order.Combinations[i].productNamesText = '';
            console.log(this.Order.Combinations[i]);
            for (
              let i2 = 0;
              i2 < this.Order.Combinations[i].productNames.length;
              i2 += 1
            ) {
              if (i2 === 0) {
                this.Order.Combinations[i].productNamesText =
                  this.Order.Combinations[i].productNames[i2];
              } else {
                this.Order.Combinations[i].productNamesText +=
                  '、' + this.Order.Combinations[i].productNames[i2];
              }
            }
          }
        })
        .catch(() => {});

      // var _this = this;
      // $.ajax({
      //   url: "shop/order/cart/getOrderChanges",
      //   type: "GET",
      //   dataType: "json"
      // })
      //   .done(function(response) {
      //       this.ShoppingOrder.isFreeFreight = response.data.isFreeFreight;
      //     this.ShoppingOrder.tradeinCount = response.data.tradeinCount;

      //     this.ShoppingOrder.payPriceTotal =
      //       response.payCartPriceTotal +
      //       this.ShoppingOrder.payPriceFreight -
      //       response.tradeinCount -
      //       this.useCoupon;
      //     this.ShoppingOrder.GiftCarts = response.GiftCarts;
      //     console.log(this.ShoppingOrder.GiftCarts);
      //     this.ShoppingOrder.Combinations = response.Combinations;
      //     for (let i = 0; i < this.ShoppingOrder.Combinations.length; i++) {
      //       this.ShoppingOrder.Combinations[i].priceTotal =
      //         this.ShoppingOrder.Combinations[i].price *
      //         this.ShoppingOrder.Combinations[i].amount;
      //       this.ShoppingOrder.Combinations[i].productNamesText = "";
      //       console.log(this.ShoppingOrder.Combinations[i]);
      //       for (
      //         let i2 = 0;
      //         i2 < this.ShoppingOrder.Combinations[i].productNames.length;
      //         i2++
      //       ) {
      //         if (i2 == 0) {
      //           this.ShoppingOrder.Combinations[i].productNamesText =
      //             this.ShoppingOrder.Combinations[i].productNames[i2];
      //         } else {
      //           this.ShoppingOrder.Combinations[i].productNamesText +=
      //             "、" + this.ShoppingOrder.Combinations[i].productNames[i2];
      //         }
      //       }
      //     }
      //   })
      //   .fail(function(response) {});
    },
    handlePreferentialDiscountCode(DiscountCodePreferentialInformations) {
      let {
        status,
        Preferential,
        preferentialDiscountCode,
        isPreferentialAvailable,
        failReason,
      } = DiscountCodePreferentialInformations;

      if (status) {
        this.discountCodePreferentials = [];
        this.discountCodePreferentials.push({
          Preferential,
          preferentialDiscountCode,
          isPreferentialAvailable,
          failReason,
        });
      }

      this.discountCode = '';
    },
    changePayPriceTotal() {
      if (
        !this.Order ||
        !this.Order.payPriceFreight ||
        !this.Order.payCartPriceTotal ||
        !this.useCoupon ||
        !this.Order.tradeinCount
      ) {
        return;
      }
      this.Order.payPriceTotal =
        this.Order.payPriceFreight +
        this.Order.payCartPriceTotal -
        this.useCoupon -
        this.Order.tradeinCount;
    },
    resetGiftCart() {
      $.ajax({
        url: 'shop/order/cart/resetGiftCart',
        type: 'POST',
        dataType: 'json',
      })
        .done(() => {
          this.getOrderChanges();
        })
        .fail(() => {});
    },
    getDiscountCodePreferential() {
      const { discountCode } = this;

      this.discountCodeText = '正在獲取優惠代碼';
      this.processing = true;

      axios
        .post('shop/order/cart/getDiscountCodePreferential', {
          discountCode,
        })
        .then((response) => {
          if (response.data.status) {
            this.changeCartsPriceTotal();
            this.discountCodeText = '';
          } else {
            this.discountCodeText = response.data.message;
          }

          this.processing = false;
        })
        .catch((err) => {
          console.log(err);
        });
    },
    deleteDiscountCodePreferential(index, discountCode) {
      console.log(index, discountCode);
      axios
        .post('shop/order/cart/deleteDiscountCodePreferential', {
          discountCode,
        })
        .then((response) => {
          if (response.data.status) {
            this.discountCodePreferentials.splice(index, 1);
            this.changeCartsPriceTotal();
          }

          this.processing = false;
        })
        .catch((err) => {
          console.log(err);
        });
    },
  },
};
</script>
