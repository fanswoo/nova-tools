<script>
export default {
  data: {
    User: Json.User,
    Transport: Json.Transport,
    payMethods: Json.payMethods || {},

    invoiceTypes: Json.invoiceTypes,
    invoiceGiveWays: Json.invoiceGiveWays,

    invoiceType: Json.electronic,
    invoiceGiveWay: Json.citizenDigitalCertificate,

    invoiceTypeElectronic: Json.electronic,
    invoiceTypeDonation: Json.donation,
    invoiceTypeTriplicate: Json.triplicate,

    invoiceGiveWayCitizenDigitalCertificate: Json.citizenDigitalCertificate,
    invoiceGiveWayCellphone: Json.cellphone,

    sameAsUser: false,

    payType: '',
    installment: null,
    receiveName: '',
    receivePhone: '',
    receiveEmail: '',
    receiveAddress: '',

    userInputReceiveName: '',
    userInputReceivePhone: '',
    userInputReceiveEmail: '',
    userInputReceiveAddress: '',
  },
  watch: {
    sameAsUser(value) {
      if (value) {
        this.userInputReceiveName = this.receiveName;
        this.userInputReceivePhone = this.receivePhone;
        this.userInputReceiveEmail = this.receiveEmail;
        this.userInputReceiveAddress = this.receiveAddress;

        if (this.User && this.User.UserFieldShop) {
          let phone =
            this.User.UserFieldShop.receivePhone ||
            this.User.UserFieldShop.mobile;

          if (phone && phone.startsWith('886')) {
            phone = '0' + phone.substring(3);
          }

          this.receiveName = this.User.UserFieldShop.receiveName;
          this.receivePhone = phone;
          this.receiveEmail = this.User.UserFieldShop.receiveEmail;
          this.receiveAddress = this.User.UserFieldShop.receiveAddress;
        } else {
          this.receiveName = '';
          this.receivePhone = '';
          this.receiveEmail = '';
          this.receiveAddress = '';
        }
      } else {
        this.receiveName = this.userInputReceiveName;
        this.receivePhone = this.userInputReceivePhone;
        this.receiveEmail = this.userInputReceiveEmail;
        this.receiveAddress = this.userInputReceiveAddress;
      }
    },
  },
  methods: {
    async setUpStoreForm() {
      if (!this.isStore) {
        return;
      }

      await axios
        .post('shop/order/checkout/checkoutStorePost', {
          store: this.Transport.logisticType,
        })
        .then((response) => {
          document.querySelector('#store').innerHTML = response.data;
          document
            .querySelector('#__paymentButton')
            .setAttribute('ff-sendtype', 'post');
          // $("#store").html(response.data);
          // $("#__paymentButton").attr('ff-sendtype', 'post');
        })
        .catch((error) => {});
    },
    async chooseStore(event) {
      event.preventDefault();
      await this.setUpStoreForm();
      //存入 sessionStorage
      this.setSessionStorage();
      document.querySelector('#__paymentButton').click();
    },
    setSessionStorage() {
      if (window.sessionStorage !== null) {
        let sessionStorage = window.sessionStorage;
        sessionStorage.setItem('payType', this.payType);
        sessionStorage.setItem('installment', this.installment);
        sessionStorage.setItem('receiveName', this.receiveName);
        sessionStorage.setItem('receivePhone', this.receivePhone);
        sessionStorage.setItem('receiveEmail', this.receiveEmail);
        sessionStorage.setItem('receiveAddress', this.receiveAddress);
      }
    },
    initPayType() {
      let payTypes = Object.keys(this.payMethods);
      if (this.hasPayMethods > 0) {
        this.payType = payTypes[0];
      }
    },
    initInstallment() {
      let payTypes = Object.keys(this.payMethods);
      if (payTypes.length > 0 && payTypes.includes('credit')) {
        let installments = this.payMethods.credit.credits;
        if (installments && installments.length > 0) {
          this.installment = installments[0];
        }
      }
    },
  },
  mounted() {
    this.initPayType();
    this.initInstallment();

    if (window.sessionStorage !== null) {
      let sessionStorage = window.sessionStorage;
      if (sessionStorage.getItem('payType')) {
        this.payType = sessionStorage.getItem('payType');
      }

      if (sessionStorage.getItem('installment')) {
        this.installment = sessionStorage.getItem('installment');
      }

      if (sessionStorage.getItem('receiveName')) {
        this.receiveName = sessionStorage.getItem('receiveName');
      }

      if (sessionStorage.getItem('receivePhone')) {
        this.receivePhone = sessionStorage.getItem('receivePhone');
      }

      if (sessionStorage.getItem('receiveEmail')) {
        this.receiveEmail = sessionStorage.getItem('receiveEmail');
      }

      if (sessionStorage.getItem('receiveAddress')) {
        this.receiveAddress = sessionStorage.getItem('receiveAddress');
      }

      sessionStorage.clear();
    }

    this.$nextTick(() => {
      this.setUpStoreForm();
    });
  },
  computed: {
    isStore() {
      return this.Transport.isStore == 1;
    },
    isUnimart() {
      let logisticType = this.Transport.logisticType;
      if (
        logisticType &&
        logisticType.toLowerCase().indexOf('unimart') !== -1
      ) {
        return true;
      }

      return false;
    },
    isFami() {
      let logisticType = this.Transport.logisticType;
      if (logisticType && logisticType.toLowerCase().indexOf('fami') !== -1) {
        return true;
      }

      return false;
    },
    isHilife() {
      let logisticType = this.Transport.logisticType;
      if (logisticType && logisticType.toLowerCase().indexOf('hilife') !== -1) {
        return true;
      }

      return false;
    },
    hasPayMethods() {
      let payTypes = Object.keys(this.payMethods);
      return payTypes.length > 0;
    },
  },
};
</script>
